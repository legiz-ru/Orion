<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>
    // Применяем тему ДО рендера страницы для избежания мерцания
    (function() {
        var theme = localStorage.getItem('theme') || 'auto';
        var isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDark) document.documentElement.classList.add('dark-theme');
    })();
    </script>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon-180x180.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png" />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6" id="themeColor">
    <meta name="description" content="<%= metaDescription %>" id="metaDesc">
    <title id="pageTitle"><%= metaTitle %></title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module" defer>
    import { polyfillCountryFlagEmojis } from "https://cdn.skypack.dev/country-flag-emoji-polyfill";
    polyfillCountryFlagEmojis();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script>
    /*! JSEncrypt v3.3.2 | https://github.com/travist/jsencrypt */
    !function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.JSEncrypt=e():t.JSEncrypt=e()}(window,(()=>(()=>{var t={155:t=>{var e,i,r=t.exports={};function n(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function o(t){if(e===setTimeout)return setTimeout(t,0);if((e===n||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(i){try{return e.call(null,t,0)}catch(i){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:n}catch(t){e=n}try{i="function"==typeof clearTimeout?clearTimeout:s}catch(t){i=s}}();var h,a=[],u=!1,c=-1;function f(){u&&h&&(u=!1,h.length?a=h.concat(a):c=-1,a.length&&l())}function l(){if(!u){var t=o(f);u=!0;for(var e=a.length;e;){for(h=a,a=[];++c<e;)h&&h[c].run();c=-1,e=a.length}h=null,u=!1,function(t){if(i===clearTimeout)return clearTimeout(t);if((i===s||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{return i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(t)}}function p(t,e){this.fun=t,this.array=e}function g(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];a.push(new p(t,e)),1!==a.length||u||o(l)},p.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=g,r.addListener=g,r.once=g,r.off=g,r.removeListener=g,r.removeAllListeners=g,r.emit=g,r.prependListener=g,r.prependOnceListener=g,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}}},e={};function i(r){var n=e[r];if(void 0!==n)return n.exports;var s=e[r]={exports:{}};return t[r](s,s.exports,i),s.exports}i.d=(t,e)=>{for(var r in e)i.o(e,r)&&!i.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var r={};return(()=>{"use strict";i.d(r,{default:()=>ct});var t="0123456789abcdefghijklmnopqrstuvwxyz";function e(e){return t.charAt(e)}function n(t,e){return t&e}function s(t,e){return t|e}function o(t,e){return t^e}function h(t,e){return t&~e}function a(t){if(0==t)return-1;var e=0;return 0==(65535&t)&&(t>>=16,e+=16),0==(255&t)&&(t>>=8,e+=8),0==(15&t)&&(t>>=4,e+=4),0==(3&t)&&(t>>=2,e+=2),0==(1&t)&&++e,e}function u(t){for(var e=0;0!=t;)t&=t-1,++e;return e}var c,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l="=";function p(t){var e,i,r="";for(e=0;e+3<=t.length;e+=3)i=parseInt(t.substring(e,e+3),16),r+=f.charAt(i>>6)+f.charAt(63&i);for(e+1==t.length?(i=parseInt(t.substring(e,e+1),16),r+=f.charAt(i<<2)):e+2==t.length&&(i=parseInt(t.substring(e,e+2),16),r+=f.charAt(i>>2)+f.charAt((3&i)<<4));(3&r.length)>0;)r+=l;return r}function g(t){var i,r="",n=0,s=0;for(i=0;i<t.length&&t.charAt(i)!=l;++i){var o=f.indexOf(t.charAt(i));o<0||(0==n?(r+=e(o>>2),s=3&o,n=1):1==n?(r+=e(s<<2|o>>4),s=15&o,n=2):2==n?(r+=e(s),r+=e(o>>2),s=3&o,n=3):(r+=e(s<<2|o>>4),r+=e(15&o),n=0))}return 1==n&&(r+=e(s<<2)),r}var d,v={decode:function(t){var e;if(void 0===d){var i="= \\f\\n\\r\\t\\u2028\\u2029";for(d=Object.create(null),e=0;e<64;++e)d["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e)]=e;for(d["-"]=62,d._=63,e=0;e<i.length;++e)d[i.charAt(e)]=-1}var r=[],n=0,s=0;for(e=0;e<t.length;++e){var o=t.charAt(e);if("="==o)break;if(-1!=(o=d[o])){if(void 0===o)throw new Error("Illegal character at offset "+e);n|=o,++s>=4?(r[r.length]=n>>16,r[r.length]=n>>8&255,r[r.length]=255&n,n=0,s=0):n<<=6}}switch(s){case 1:throw new Error("Base64 encoding incomplete: at least 2 bits missing");case 2:r[r.length]=n>>10;break;case 3:r[r.length]=n>>16,r[r.length]=n>>8&255}return r},re:/-----BEGIN [^-]+-----([A-Za-z0-9+\\/=\\s]+)-----END [^-]+-----|begin-base64[^\\n]+\\n([A-Za-z0-9+\\/=\\s]+)====/,unarmor:function(t){var e=v.re.exec(t);if(e)if(e[1])t=e[1];else{if(!e[2])throw new Error("RegExp out of sync");t=e[2]}return v.decode(t)}},m=1e13,y=function(){function t(t){this.buf=[+t||0]}return t.prototype.mulAdd=function(t,e){var i,r,n=this.buf,s=n.length;for(i=0;i<s;++i)(r=n[i]*t+e)<m?e=0:r-=(e=0|r/m)*m,n[i]=r;e>0&&(n[i]=e)},t.prototype.sub=function(t){var e,i,r=this.buf,n=r.length;for(e=0;e<n;++e)(i=r[e]-t)<0?(i+=m,t=1):t=0,r[e]=i;for(;0===r[r.length-1];)r.pop()},t.prototype.toString=function(t){if(10!=(t||10))throw new Error("only base 10 is supported");for(var e=this.buf,i=e[e.length-1].toString(),r=e.length-2;r>=0;--r)i+=(m+e[r]).toString().substring(1);return i},t.prototype.valueOf=function(){for(var t=this.buf,e=0,i=t.length-1;i>=0;--i)e=e*m+t[i];return e},t.prototype.simplify=function(){var t=this.buf;return 1==t.length?t[0]:this},t}(),b="…",T=/^(\\d\\d)(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])([01]\\d|2[0-3])(?:([0-5]\\d)(?:([0-5]\\d)(?:[.,](\\d{1,3}))?)?)?$  /,S=/^(\\d\\d\\d\\d)(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])([01]\\d|2[0-3])(?:([0-5]\\d)(?:([0-5]\\d)(?:[.,](\\d{1,3}))?)?)?$/;function E(t,e){return t.length>e&&(t=t.substring(0,e)+b),t}var w,D=function(){function t(e,i){this.hexDigits="0123456789ABCDEF",e instanceof t?(this.enc=e.enc,this.pos=e.pos):(this.enc=e,this.pos=i)}return t.prototype.get=function(t){if(void 0===t&&(t=this.pos++),t>=this.enc.length)throw new Error("Requesting byte offset ".concat(t," on a stream of length ").concat(this.enc.length));return"string"==typeof this.enc?this.enc.charCodeAt(t):this.enc[t]},t.prototype.hexByte=function(t){return this.hexDigits.charAt(t>>4&15)+this.hexDigits.charAt(15&t)},t.prototype.hexDump=function(t,e,i){for(var r="",n=t;n<e;++n)if(r+=this.hexByte(this.get(n)),!0!==i)switch(15&n){case 7:r+="  ";break;case 15:r+="\\n";break;default:r+=" "}return r},t.prototype.isASCII=function(t,e){for(var i=t;i<e;++i){var r=this.get(i);if(r<32||r>176)return!1}return!0},t.prototype.parseStringISO=function(t,e){for(var i="",r=t;r<e;++r)i+=String.fromCharCode(this.get(r));return i},t.prototype.parseStringUTF=function(t,e){for(var i="",r=t;r<e;){var n=this.get(r++);i+=n<128?String.fromCharCode(n):n>191&&n<224?String.fromCharCode((31&n)<<6|63&this.get(r++)):String.fromCharCode((15&n)<<12|(63&this.get(r++))<<6|63&this.get(r++))}return i},t.prototype.parseStringBMP=function(t,e){for(var i,r,n="",s=t;s<e;)i=this.get(s++),r=this.get(s++),n+=String.fromCharCode(i<<8|r);return n},t.prototype.parseTime=function(t,e,i){var r=this.parseStringISO(t,e),n=(i?T:S).exec(r);return n?(i&&(n[1]=+n[1],n[1]+=+n[1]<70?2e3:1900),r=n[1]+"-"+n[2]+"-"+n[3]+" "+n[4],n[5]&&(r+=":"+n[5],n[6]&&(r+=":"+n[6],n[7]&&(r+="."+n[7]))),n[8]&&(r+=" UTC","Z"!=n[8]&&(r+=n[8],n[9]&&(r+=":"+n[9]))),r):"Unrecognized time: "+r},t.prototype.parseInteger=function(t,e){for(var i,r=this.get(t),n=r>127,s=n?255:0,o="";r==s&&++t<e;)r=this.get(t);if(0==(i=e-t))return n?-1:0;if(i>4){for(o=r,i<<=3;0==(128&(+o^s));)o=+o<<1,--i;o="("+i+" bit)\\n"}n&&(r-=256);for(var h=new y(r),a=t+1;a<e;++a)h.mulAdd(256,this.get(a));return o+h.toString()},t.prototype.parseBitString=function(t,e,i){for(var r=this.get(t),n="("+((e-t-1<<3)-r)+" bit)\\n",s="",o=t+1;o<e;++o){for(var h=this.get(o),a=o==e-1?r:0,u=7;u>=a;--u)s+=h>>u&1?"1":"0";if(s.length>i)return n+E(s,i)}return n+s},t.prototype.parseOctetString=function(t,e,i){if(this.isASCII(t,e))return E(this.parseStringISO(t,e),i);var r=e-t,n="("+r+" byte)\\n";r>(i/=2)&&(e=t+i);for(var s=t;s<e;++s)n+=this.hexByte(this.get(s));return r>i&&(n+=b),n},t.prototype.parseOID=function(t,e,i){for(var r="",n=new y,s=0,o=t;o<e;++o){var h=this.get(o);if(n.mulAdd(128,127&h),s+=7,!(128&h)){if(""===r)if((n=n.simplify())instanceof y)n.sub(80),r="2."+n.toString();else{var a=n<80?n<40?0:1:2;r=a+"."+(n-40*a)}else r+="."+n.toString();if(r.length>i)return E(r,i);n=new y,s=0}}return s>0&&(r+=".incomplete"),r},t}(),x=function(){function t(t,e,i,r,n){if(!(r instanceof R))throw new Error("Invalid tag value.");this.stream=t,this.header=e,this.length=i,this.tag=r,this.sub=n}return t.prototype.typeName=function(){switch(this.tag.tagClass){case 0:switch(this.tag.tagNumber){case 0:return"EOC";case 1:return"BOOLEAN";case 2:return"INTEGER";case 3:return"BIT_STRING";case 4:return"OCTET_STRING";case 5:return"NULL";case 6:return"OBJECT_IDENTIFIER";case 7:return"ObjectDescriptor";case 8:return"EXTERNAL";case 9:return"REAL";case 10:return"ENUMERATED";case 11:return"EMBEDDED_PDV";case 12:return"UTF8String";case 16:return"SEQUENCE";case 17:return"SET";case 18:return"NumericString";case 19:return"PrintableString";case 20:return"TeletexString";case 21:return"VideotexString";case 22:return"IA5String";case 23:return"UTCTime";case 24:return"GeneralizedTime";case 25:return"GraphicString";case 26:return"VisibleString";case 27:return"GeneralString";case 28:return"UniversalString";case 30:return"BMPString"}return"Universal_"+this.tag.tagNumber.toString();case 1:return"Application_"+this.tag.tagNumber.toString();case 2:return"["+this.tag.tagNumber.toString()+"]";case 3:return"Private_"+this.tag.tagNumber.toString()}},t.prototype.content=function(t){if(void 0===this.tag)return null;void 0===t&&(t=1/0);var e=this.posContent(),i=Math.abs(this.length);if(!this.tag.isUniversal())return null!==this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(e,e+i,t);switch(this.tag.tagNumber){case 1:return 0===this.stream.get(e)?"false":"true";case 2:return this.stream.parseInteger(e,e+i);case 3:return this.sub?"("+this.sub.length+" elem)":this.stream.parseBitString(e,e+i,t);case 4:return this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(e,e+i,t);case 6:return this.stream.parseOID(e,e+i,t);case 16:case 17:return null!==this.sub?"("+this.sub.length+" elem)":"(no elem)";case 12:return E(this.stream.parseStringUTF(e,e+i),t);case 18:case 19:case 20:case 21:case 22:case 26:return E(this.stream.parseStringISO(e,e+i),t);case 30:return E(this.stream.parseStringBMP(e,e+i),t);case 23:case 24:return this.stream.parseTime(e,e+i,23==this.tag.tagNumber)}return null},t.prototype.toString=function(){return this.typeName()+"@"+this.stream.pos+"[header:"+this.header+",length:"+this.length+",sub:"+(null===this.sub?"null":this.sub.length)+"]"},t.prototype.toPrettyString=function(t){void 0===t&&(t="");var e=t+this.typeName()+" @"+this.stream.pos;if(this.length>=0&&(e+="+"),e+=this.length,this.tag.tagConstructed?e+=" (constructed)":!this.tag.isUniversal()||3!=this.tag.tagNumber&&4!=this.tag.tagNumber||null===this.sub||(e+=" (encapsulates)"),e+="\\n",null!==this.sub){t+="  ";for(var i=0,r=this.sub.length;i<r;++i)e+=this.sub[i].toPrettyString(t)}return e},t.prototype.posStart=function(){return this.stream.pos},t.prototype.posContent=function(){return this.stream.pos+this.header},t.prototype.posEnd=function(){return this.stream.pos+this.header+Math.abs(this.length)},t.prototype.toHexString=function(){return this.stream.hexDump(this.posStart(),this.posEnd(),!0)},t.decodeLength=function(t){var e=t.get(),i=127&e;if(i==e)return i;if(i>6)throw new Error("Length over 48 bits not supported at position "+(t.pos-1));if(0===i)return null;e=0;for(var r=0;r<i;++r)e=256*e+t.get();return e},t.prototype.getHexStringValue=function(){var t=this.toHexString(),e=2*this.header,i=2*this.length;return t.substr(e,i)},t.decode=function(e){var i;i=e instanceof D?e:new D(e,0);var r=new D(i),n=new R(i),s=t.decodeLength(i),o=i.pos,h=o-r.pos,a=null,u=function(){var e=[];if(null!==s){for(var r=o+s;i.pos<r;)e[e.length]=t.decode(i);if(i.pos!=r)throw new Error("Content size is not correct for container starting at offset "+o)}else try{for(;;){var n=t.decode(i);if(n.tag.isEOC())break;e[e.length]=n}s=o-i.pos}catch(t){throw new Error("Exception while decoding undefined length content: "+t)}return e};if(n.tagConstructed)a=u();else if(n.isUniversal()&&(3==n.tagNumber||4==n.tagNumber))try{if(3==n.tagNumber&&0!=i.get())throw new Error("BIT STRINGs with unused bits cannot encapsulate.");a=u();for(var c=0;c<a.length;++c)if(a[c].tag.isEOC())throw new Error("EOC is not supposed to be actual content.")}catch(t){a=null}if(null===a){if(null===s)throw new Error("We can't skip over an invalid tag with undefined length at offset "+o);i.pos=o+Math.abs(s)}return new t(r,h,s,n,a)},t}(),R=function(){function t(t){var e=t.get();if(this.tagClass=e>>6,this.tagConstructed=0!=(32&e),this.tagNumber=31&e,31==this.tagNumber){var i=new y;do{e=t.get(),i.mulAdd(128,127&e)}while(128&e);this.tagNumber=i.simplify()}}return t.prototype.isUniversal=function(){return 0===this.tagClass},t.prototype.isEOC=function(){return 0===this.tagClass&&0===this.tagNumber},t}(),B=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],O=(1<<26)/B[B.length-1],A=function(){function t(t,e,i){null!=t&&("number"==typeof t?this.fromNumber(t,e,i):null==e&&"string"!=typeof t?this.fromString(t,256):this.fromString(t,e))}return t.prototype.toString=function(t){if(this.s<0)return"-"+this.negate().toString(t);var i;if(16==t)i=4;else if(8==t)i=3;else if(2==t)i=1;else if(32==t)i=5;else{if(4!=t)return this.toRadix(t);i=2}var r,n=(1<<i)-1,s=!1,o="",h=this.t,a=this.DB-h*this.DB%i;if(h-- >0)for(a<this.DB&&(r=this[h]>>a)>0&&(s=!0,o=e(r));h>=0;)a<i?(r=(this[h]&(1<<a)-1)<<i-a,r|=this[--h]>>(a+=this.DB-i)):(r=this[h]>>(a-=i)&n,a<=0&&(a+=this.DB,--h)),r>0&&(s=!0),s&&(o+=e(r));return s?o:"0"},t.prototype.negate=function(){var e=M();return t.ZERO.subTo(this,e),e},t.prototype.abs=function(){return this.s<0?this.negate():this},t.prototype.compareTo=function(t){var e=this.s-t.s;if(0!=e)return e;var i=this.t;if(0!=(e=i-t.t))return this.s<0?-e:e;for(;--i>=0;)if(0!=(e=this[i]-t[i]))return e;return 0},t.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+K(this[this.t-1]^this.s&this.DM)},t.prototype.mod=function(e){var i=M();return this.abs().divRemTo(e,null,i),this.s<0&&i.compareTo(t.ZERO)>0&&e.subTo(i,i),i},t.prototype.modPowInt=function(t,e){var i;return i=t<256||e.isEven()?new I(e):new N(e),this.exp(t,i)},t.prototype.clone=function(){var t=M();return this.copyTo(t),t},t.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},t.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24},t.prototype.shortValue=function(){return 0==this.t?this.s:this[0]<<16>>16},t.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},t.prototype.toByteArray=function(){var t=this.t,e=[];e[0]=this.s;var i,r=this.DB-t*this.DB%8,n=0;if(t-- >0)for(r<this.DB&&(i=this[t]>>r)!=(this.s&this.DM)>>r&&(e[n++]=i|this.s<<this.DB-r);t>=0;)r<8?(i=(this[t]&(1<<r)-1)<<8-r,i|=this[--t]>>(r+=this.DB-8)):(i=this[t]>>(r-=8)&255,r<=0&&(r+=this.DB,--t)),0!=(128&i)&&(i|=-256),0==n&&(128&this.s)!=(128&i)&&++n,(n>0||i!=this.s)&&(e[n++]=i);return e},t.prototype.equals=function(t){return 0==this.compareTo(t)},t.prototype.min=function(t){return this.compareTo(t)<0?this:t},t.prototype.max=function(t){return this.compareTo(t)>0?this:t},t.prototype.and=function(t){var e=M();return this.bitwiseTo(t,n,e),e},t.prototype.or=function(t){var e=M();return this.bitwiseTo(t,s,e),e},t.prototype.xor=function(t){var e=M();return this.bitwiseTo(t,o,e),e},t.prototype.andNot=function(t){var e=M();return this.bitwiseTo(t,h,e),e},t.prototype.not=function(){for(var t=M(),e=0;e<this.t;++e)t[e]=this.DM&~this[e];return t.t=this.t,t.s=~this.s,t},t.prototype.shiftLeft=function(t){var e=M();return t<0?this.rShiftTo(-t,e):this.lShiftTo(t,e),e},t.prototype.shiftRight=function(t){var e=M();return t<0?this.lShiftTo(-t,e):this.rShiftTo(t,e),e},t.prototype.getLowestSetBit=function(){for(var t=0;t<this.t;++t)if(0!=this[t])return t*this.DB+a(this[t]);return this.s<0?this.t*this.DB:-1},t.prototype.bitCount=function(){for(var t=0,e=this.s&this.DM,i=0;i<this.t;++i)t+=u(this[i]^e);return t},t.prototype.testBit=function(t){var e=Math.floor(t/this.DB);return e>=this.t?0!=this.s:0!=(this[e]&1<<t%this.DB)},t.prototype.setBit=function(t){return this.changeBit(t,s)},t.prototype.clearBit=function(t){return this.changeBit(t,h)},t.prototype.flipBit=function(t){return this.changeBit(t,o)},t.prototype.add=function(t){var e=M();return this.addTo(t,e),e},t.prototype.subtract=function(t){var e=M();return this.subTo(t,e),e},t.prototype.multiply=function(t){var e=M();return this.multiplyTo(t,e),e},t.prototype.divide=function(t){var e=M();return this.divRemTo(t,e,null),e},t.prototype.remainder=function(t){var e=M();return this.divRemTo(t,null,e),e},t.prototype.divideAndRemainder=function(t){var e=M(),i=M();return this.divRemTo(t,e,i),[e,i]},t.prototype.modPow=function(t,e){var i,r,n=t.bitLength(),s=U(1);if(n<=0)return s;i=n<18?1:n<48?3:n<144?4:n<768?5:6,r=n<8?new I(e):e.isEven()?new P(e):new N(e);var o=[],h=3,a=i-1,u=(1<<i)-1;if(o[1]=r.convert(this),i>1){var c=M();for(r.sqrTo(o[1],c);h<=u;)o[h]=M(),r.mulTo(c,o[h-2],o[h]),h+=2}var f,l,p=t.t-1,g=!0,d=M();for(n=K(t[p])-1;p>=0;){for(n>=a?f=t[p]>>n-a&u:(f=(t[p]&(1<<n+1)-1)<<a-n,p>0&&(f|=t[p-1]>>this.DB+n-a)),h=i;0==(1&f);)f>>=1,--h;if((n-=h)<0&&(n+=this.DB,--p),g)o[f].copyTo(s),g=!1;else{for(;h>1;)r.sqrTo(s,d),r.sqrTo(d,s),h-=2;h>0?r.sqrTo(s,d):(l=s,s=d,d=l),r.mulTo(d,o[f],s)}for(;p>=0&&0==(t[p]&1<<n);)r.sqrTo(s,d),l=s,s=d,d=l,--n<0&&(n=this.DB-1,--p)}return r.revert(s)},t.prototype.modInverse=function(e){var i=e.isEven();if(this.isEven()&&i||0==e.signum())return t.ZERO;for(var r=e.clone(),n=this.clone(),s=U(1),o=U(0),h=U(0),a=U(1);0!=r.signum();){for(;r.isEven();)r.rShiftTo(1,r),i?(s.isEven()&&o.isEven()||(s.addTo(this,s),o.subTo(e,o)),s.rShiftTo(1,s)):o.isEven()||o.subTo(e,o),o.rShiftTo(1,o);for(;n.isEven();)n.rShiftTo(1,n),i?(h.isEven()&&a.isEven()||(h.addTo(this,h),a.subTo(e,a)),h.rShiftTo(1,h)):a.isEven()||a.subTo(e,a),a.rShiftTo(1,a);r.compareTo(n)>=0?(r.subTo(n,r),i&&s.subTo(h,s),o.subTo(a,o)):(n.subTo(r,n),i&&h.subTo(s,h),a.subTo(o,a))}return 0!=n.compareTo(t.ONE)?t.ZERO:a.compareTo(e)>=0?a.subtract(e):a.signum()<0?(a.addTo(e,a),a.signum()<0?a.add(e):a):a},t.prototype.pow=function(t){return this.exp(t,new V)},t.prototype.gcd=function(t){var e=this.s<0?this.negate():this.clone(),i=t.s<0?t.negate():t.clone();if(e.compareTo(i)<0){var r=e;e=i,i=r}var n=e.getLowestSetBit(),s=i.getLowestSetBit();if(s<0)return e;for(n<s&&(s=n),s>0&&(e.rShiftTo(s,e),i.rShiftTo(s,i));e.signum()>0;)(n=e.getLowestSetBit())>0&&e.rShiftTo(n,e),(n=i.getLowestSetBit())>0&&i.rShiftTo(n,i),e.compareTo(i)>=0?(e.subTo(i,e),e.rShiftTo(1,e)):(i.subTo(e,i),i.rShiftTo(1,i));return s>0&&i.lShiftTo(s,i),i},t.prototype.isProbablePrime=function(t){var e,i=this.abs();if(1==i.t&&i[0]<=B[B.length-1]){for(e=0;e<B.length;++e)if(i[0]==B[e])return!0;return!1}if(i.isEven())return!1;for(e=1;e<B.length;){for(var r=B[e],n=e+1;n<B.length&&r<O;)r*=B[n++];for(r=i.modInt(r);e<n;)if(r%B[e++]==0)return!1}return i.millerRabin(t)},t.prototype.copyTo=function(t){for(var e=this.t-1;e>=0;--e)t[e]=this[e];t.t=this.t,t.s=this.s},t.prototype.fromInt=function(t){this.t=1,this.s=t<0?-1:0,t>0?this[0]=t:t<-1?this[0]=t+this.DV:this.t=0},t.prototype.fromString=function(e,i){var r;if(16==i)r=4;else if(8==i)r=3;else if(256==i)r=8;else if(2==i)r=1;else if(32==i)r=5;else{if(4!=i)return void this.fromRadix(e,i);r=2}this.t=0,this.s=0;for(var n=e.length,s=!1,o=0;--n>=0;){var h=8==r?255&+e[n]:F(e,n);h<0?"-"==e.charAt(n)&&(s=!0):(s=!1,0==o?this[this.t++]=h:o+r>this.DB?(this[this.t-1]|=(h&(1<<this.DB-o)-1)<<o,this[this.t++]=h>>this.DB-o):this[this.t-1]|=h<<o,(o+=r)>=this.DB&&(o-=this.DB))}8==r&&0!=(128&+e[0])&&(this.s=-1,o>0&&(this[this.t-1]|=(1<<this.DB-o)-1<<o)),this.clamp(),s&&t.ZERO.subTo(this,this)},t.prototype.clamp=function(){for(var t=this.s&this.DM;this.t>0&&this[this.t-1]==t;)--this.t},t.prototype.dlShiftTo=function(t,e){var i;for(i=this.t-1;i>=0;--i)e[i+t]=this[i];for(i=t-1;i>=0;--i)e[i]=0;e.t=this.t+t,e.s=this.s},t.prototype.drShiftTo=function(t,e){for(var i=t;i<this.t;++i)e[i-t]=this[i];e.t=Math.max(this.t-t,0),e.s=this.s},t.prototype.lShiftTo=function(t,e){for(var i=t%this.DB,r=this.DB-i,n=(1<<r)-1,s=Math.floor(t/this.DB),o=this.s<<i&this.DM,h=this.t-1;h>=0;--h)e[h+s+1]=this[h]>>r|o,o=(this[h]&n)<<i;for(h=s-1;h>=0;--h)e[h]=0;e[s]=o,e.t=this.t+s+1,e.s=this.s,e.clamp()},t.prototype.rShiftTo=function(t,e){e.s=this.s;var i=Math.floor(t/this.DB);if(i>=this.t)e.t=0;else{var r=t%this.DB,n=this.DB-r,s=(1<<r)-1;e[0]=this[i]>>r;for(var o=i+1;o<this.t;++o)e[o-i-1]|=(this[o]&s)<<n,e[o-i]=this[o]>>r;r>0&&(e[this.t-i-1]|=(this.s&s)<<n),e.t=this.t-i,e.clamp()}},t.prototype.subTo=function(t,e){for(var i=0,r=0,n=Math.min(t.t,this.t);i<n;)r+=this[i]-t[i],e[i++]=r&this.DM,r>>=this.DB;if(t.t<this.t){for(r-=t.s;i<this.t;)r+=this[i],e[i++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;i<t.t;)r-=t[i],e[i++]=r&this.DM,r>>=this.DB;r-=t.s}e.s=r<0?-1:0,r<-1?e[i++]=this.DV+r:r>0&&(e[i++]=r),e.t=i,e.clamp()},t.prototype.multiplyTo=function(e,i){var r=this.abs(),n=e.abs(),s=r.t;for(i.t=s+n.t;--s>=0;)i[s]=0;for(s=0;s<n.t;++s)i[s+r.t]=r.am(0,n[s],i,s,0,r.t);i.s=0,i.clamp(),this.s!=e.s&&t.ZERO.subTo(i,i)},t.prototype.squareTo=function(t){for(var e=this.abs(),i=t.t=2*e.t;--i>=0;)t[i]=0;for(i=0;i<e.t-1;++i){var r=e.am(i,e[i],t,2*i,0,1);(t[i+e.t]+=e.am(i+1,2*e[i],t,2*i+1,r,e.t-i-1))>=e.DV&&(t[i+e.t]-=e.DV,t[i+e.t+1]=1)}t.t>0&&(t[t.t-1]+=e.am(i,e[i],t,2*i,0,1)),t.s=0,t.clamp()},t.prototype.divRemTo=function(e,i,r){var n=e.abs();if(!(n.t<=0)){var s=this.abs();if(s.t<n.t)return null!=i&&i.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=M());var o=M(),h=this.s,a=e.s,u=this.DB-K(n[n.t-1]);u>0?(n.lShiftTo(u,o),s.lShiftTo(u,r)):(n.copyTo(o),s.copyTo(r));var c=o.t,f=o[c-1];if(0!=f){var l=f*(1<<this.F1)+(c>1?o[c-2]>>this.F2:0),p=this.FV/l,g=(1<<this.F1)/l,d=1<<this.F2,v=r.t,m=v-c,y=null==i?M():i;for(o.dlShiftTo(m,y),r.compareTo(y)>=0&&(r[r.t++]=1,r.subTo(y,r)),t.ONE.dlShiftTo(c,y),y.subTo(o,o);o.t<c;)o[o.t++]=0;for(;--m>=0;){var b=r[--v]==f?this.DM:Math.floor(r[v]*p+(r[v-1]+d)*g);if((r[v]+=o.am(0,b,r,m,0,c))<b)for(o.dlShiftTo(m,y),r.subTo(y,r);r[v]<--b;)r.subTo(y,r)}null!=i&&(r.drShiftTo(c,i),h!=a&&t.ZERO.subTo(i,i)),r.t=c,r.clamp(),u>0&&r.rShiftTo(u,r),h<0&&t.ZERO.subTo(r,r)}}},t.prototype.invDigit=function(){if(this.t<1)return 0;var t=this[0];if(0==(1&t))return 0;var e=3&t;return(e=(e=(e=(e=e*(2-(15&t)*e)&15)*(2-(255&t)*e)&255)*(2-((65535&t)*e&65535))&65535)*(2-t*e%this.DV)%this.DV)>0?this.DV-e:-e},t.prototype.isEven=function(){return 0==(this.t>0?1&this[0]:this.s)},t.prototype.exp=function(e,i){if(e>4294967295||e<1)return t.ONE;var r=M(),n=M(),s=i.convert(this),o=K(e)-1;for(s.copyTo(r);--o>=0;)if(i.sqrTo(r,n),(e&1<<o)>0)i.mulTo(n,s,r);else{var h=r;r=n,n=h}return i.revert(r)},t.prototype.chunkSize=function(t){return Math.floor(Math.LN2*this.DB/Math.log(t))},t.prototype.toRadix=function(t){if(null==t&&(t=10),0==this.signum()||t<2||t>36)return"0";var e=this.chunkSize(t),i=Math.pow(t,e),r=U(i),n=M(),s=M(),o="";for(this.divRemTo(r,n,s);n.signum()>0;)o=(i+s.intValue()).toString(t).substr(1)+o,n.divRemTo(r,n,s);return s.intValue().toString(t)+o},t.prototype.fromRadix=function(e,i){this.fromInt(0),null==i&&(i=10);for(var r=this.chunkSize(i),n=Math.pow(i,r),s=!1,o=0,h=0,a=0;a<e.length;++a){var u=F(e,a);u<0?"-"==e.charAt(a)&&0==this.signum()&&(s=!0):(h=i*h+u,++o>=r&&(this.dMultiply(n),this.dAddOffset(h,0),o=0,h=0))}o>0&&(this.dMultiply(Math.pow(i,o)),this.dAddOffset(h,0)),s&&t.ZERO.subTo(this,this)},t.prototype.fromNumber=function(e,i,r){if("number"==typeof i)if(e<2)this.fromInt(1);else for(this.fromNumber(e,r),this.testBit(e-1)||this.bitwiseTo(t.ONE.shiftLeft(e-1),s,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(i);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(t.ONE.shiftLeft(e-1),this);else{var n=[],o=7&e;n.length=1+(e>>3),i.nextBytes(n),o>0?n[0]&=(1<<o)-1:n[0]=0,this.fromString(n,256)}},t.prototype.bitwiseTo=function(t,e,i){var r,n,s=Math.min(t.t,this.t);for(r=0;r<s;++r)i[r]=e(this[r],t[r]);if(t.t<this.t){for(n=t.s&this.DM,r=s;r<this.t;++r)i[r]=e(this[r],n);i.t=this.t}else{for(n=this.s&this.DM,r=s;r<t.t;++r)i[r]=e(n,t[r]);i.t=t.t}i.s=e(this.s,t.s),i.clamp()},t.prototype.changeBit=function(e,i){var r=t.ONE.shiftLeft(e);return this.bitwiseTo(r,i,r),r},t.prototype.addTo=function(t,e){for(var i=0,r=0,n=Math.min(t.t,this.t);i<n;)r+=this[i]+t[i],e[i++]=r&this.DM,r>>=this.DB;if(t.t<this.t){for(r+=t.s;i<this.t;)r+=this[i],e[i++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;i<t.t;)r+=t[i],e[i++]=r&this.DM,r>>=this.DB;r+=t.s}e.s=r<0?-1:0,r>0?e[i++]=r:r<-1&&(e[i++]=this.DV+r),e.t=i,e.clamp()},t.prototype.dMultiply=function(t){this[this.t]=this.am(0,t-1,this,0,0,this.t),++this.t,this.clamp()},t.prototype.dAddOffset=function(t,e){if(0!=t){for(;this.t<=e;)this[this.t++]=0;for(this[e]+=t;this[e]>=this.DV;)this[e]-=this.DV,++e>=this.t&&(this[this.t++]=0),++this[e]}},t.prototype.multiplyLowerTo=function(t,e,i){var r=Math.min(this.t+t.t,e);for(i.s=0,i.t=r;r>0;)i[--r]=0;for(var n=i.t-this.t;r<n;++r)i[r+this.t]=this.am(0,t[r],i,r,0,this.t);for(n=Math.min(t.t,e);r<n;++r)this.am(0,t[r],i,r,0,e-r);i.clamp()},t.prototype.multiplyUpperTo=function(t,e,i){--e;var r=i.t=this.t+t.t-e;for(i.s=0;--r>=0;)i[r]=0;for(r=Math.max(e-this.t,0);r<t.t;++r)i[this.t+r-e]=this.am(e-r,t[r],i,0,0,this.t+r-e);i.clamp(),i.drShiftTo(1,i)},t.prototype.modInt=function(t){if(t<=0)return 0;var e=this.DV%t,i=this.s<0?t-1:0;if(this.t>0)if(0==e)i=this[0]%t;else for(var r=this.t-1;r>=0;--r)i=(e*i+this[r])%t;return i},t.prototype.millerRabin=function(e){var i=this.subtract(t.ONE),r=i.getLowestSetBit();if(r<=0)return!1;var n=i.shiftRight(r);(e=e+1>>1)>B.length&&(e=B.length);for(var s=M(),o=0;o<e;++o){s.fromInt(B[Math.floor(Math.random()*B.length)]);var h=s.modPow(n,this);if(0!=h.compareTo(t.ONE)&&0!=h.compareTo(i)){for(var a=1;a++<r&&0!=h.compareTo(i);)if(0==(h=h.modPowInt(2,this)).compareTo(t.ONE))return!1;if(0!=h.compareTo(i))return!1}}return!0},t.prototype.square=function(){var t=M();return this.squareTo(t),t},t.prototype.gcda=function(t,e){var i=this.s<0?this.negate():this.clone(),r=t.s<0?t.negate():t.clone();if(i.compareTo(r)<0){var n=i;i=r,r=n}var s=i.getLowestSetBit(),o=r.getLowestSetBit();if(o<0)e(i);else{s<o&&(o=s),o>0&&(i.rShiftTo(o,i),r.rShiftTo(o,r));var h=function(){(s=i.getLowestSetBit())>0&&i.rShiftTo(s,i),(s=r.getLowestSetBit())>0&&r.rShiftTo(s,r),i.compareTo(r)>=0?(i.subTo(r,i),i.rShiftTo(1,i)):(r.subTo(i,r),r.rShiftTo(1,r)),i.signum()>0?setTimeout(h,0):(o>0&&r.lShiftTo(o,r),setTimeout((function(){e(r)}),0))};setTimeout(h,10)}},t.prototype.fromNumberAsync=function(e,i,r,n){if("number"==typeof i)if(e<2)this.fromInt(1);else{this.fromNumber(e,r),this.testBit(e-1)||this.bitwiseTo(t.ONE.shiftLeft(e-1),s,this),this.isEven()&&this.dAddOffset(1,0);var o=this,h=function(){o.dAddOffset(2,0),o.bitLength()>e&&o.subTo(t.ONE.shiftLeft(e-1),o),o.isProbablePrime(i)?setTimeout((function(){n()}),0):setTimeout(h,0)};setTimeout(h,0)}else{var a=[],u=7&e;a.length=1+(e>>3),i.nextBytes(a),u>0?a[0]&=(1<<u)-1:a[0]=0,this.fromString(a,256)}},t}(),V=function(){function t(){}return t.prototype.convert=function(t){return t},t.prototype.revert=function(t){return t},t.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i)},t.prototype.sqrTo=function(t,e){t.squareTo(e)},t}(),I=function(){function t(t){this.m=t}return t.prototype.convert=function(t){return t.s<0||t.compareTo(this.m)>=0?t.mod(this.m):t},t.prototype.revert=function(t){return t},t.prototype.reduce=function(t){t.divRemTo(this.m,null,t)},t.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i),this.reduce(i)},t.prototype.sqrTo=function(t,e){t.squareTo(e),this.reduce(e)},t}(),N=function(){function t(t){this.m=t,this.mp=t.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<t.DB-15)-1,this.mt2=2*t.t}return t.prototype.convert=function(t){var e=M();return t.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),t.s<0&&e.compareTo(A.ZERO)>0&&this.m.subTo(e,e),e},t.prototype.revert=function(t){var e=M();return t.copyTo(e),this.reduce(e),e},t.prototype.reduce=function(t){for(;t.t<=this.mt2;)t[t.t++]=0;for(var e=0;e<this.m.t;++e){var i=32767&t[e],r=i*this.mpl+((i*this.mph+(t[e]>>15)*this.mpl&this.um)<<15)&t.DM;for(t[i=e+this.m.t]+=this.m.am(0,r,t,e,0,this.m.t);t[i]>=t.DV;)t[i]-=t.DV,t[++i]++}t.clamp(),t.drShiftTo(this.m.t,t),t.compareTo(this.m)>=0&&t.subTo(this.m,t)},t.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i),this.reduce(i)},t.prototype.sqrTo=function(t,e){t.squareTo(e),this.reduce(e)},t}(),P=function(){function t(t){this.m=t,this.r2=M(),this.q3=M(),A.ONE.dlShiftTo(2*t.t,this.r2),this.mu=this.r2.divide(t)}return t.prototype.convert=function(t){if(t.s<0||t.t>2*this.m.t)return t.mod(this.m);if(t.compareTo(this.m)<0)return t;var e=M();return t.copyTo(e),this.reduce(e),e},t.prototype.revert=function(t){return t},t.prototype.reduce=function(t){for(t.drShiftTo(this.m.t-1,this.r2),t.t>this.m.t+1&&(t.t=this.m.t+1,t.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);t.compareTo(this.r2)<0;)t.dAddOffset(1,this.m.t+1);for(t.subTo(this.r2,t);t.compareTo(this.m)>=0;)t.subTo(this.m,t)},t.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i),this.reduce(i)},t.prototype.sqrTo=function(t,e){t.squareTo(e),this.reduce(e)},t}();function M(){return new A(null)}function U(t){return new A(t)}function F(t,e){if(e<t.length+11)return console.error("Message too long for RSA"),null;for(var i=[],r=t.length-1;r>=0&&e>0;){var n=t.charCodeAt(r--);n<128?i[--e]=n:n>127&&n<2048?(i[--e]=63&n|128,i[--e]=n>>6|192):(i[--e]=63&n|128,i[--e]=n>>6&63|128,i[--e]=n>>12|224)}i[--e]=0;for(var s=new Y,o=[];e>2;){for(o[0]=0;0==o[0];)s.nextBytes(o);i[--e]=o[0]}return i[--e]=2,i[--e]=0,new A(i)}function j(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function z(t){var e,i,r="";for(e=0;e+3<=t.length;e+=3)i=parseInt(t.substring(e,e+3),16),r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(i>>6)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(63&i);return e+1==t.length?(i=parseInt(t.substring(e,e+1),16),r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(i<<2)):e+2==t.length&&(i=parseInt(t.substring(e,e+2),16),r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(i>>2)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((3&i)<<4)),(1&r.length)>0&&(r+="="),r}function H(t){var e,i,r=v.unarmor(t),n=x.decode(r);if(3===n.sub.length&&(n=n.sub[2].sub[0]),9===n.sub.length){e=n.sub[1].getHexStringValue(),this.n=U(e,16),i=n.sub[2].getHexStringValue(),this.e=parseInt(i,16);var s=n.sub[3].getHexStringValue();this.d=U(s,16);var o=n.sub[4].getHexStringValue();this.p=U(o,16);var h=n.sub[5].getHexStringValue();this.q=U(h,16);var a=n.sub[6].getHexStringValue();this.dmp1=U(a,16);var u=n.sub[7].getHexStringValue();this.dmq1=U(u,16);var c=n.sub[8].getHexStringValue();this.coeff=U(c,16)}else{if(2!==n.sub.length)return!1;var f=n.sub[1].sub[0];e=f.sub[0].getHexStringValue(),this.n=U(e,16),i=f.sub[1].getHexStringValue(),this.e=parseInt(i,16)}}function L(){var t=new Y,e=new Array;e[0]=window.crypto||window.msCrypto;var i=0;if(window.crypto&&window.crypto.getRandomValues)try{var r=new Uint32Array(256);for(window.crypto.getRandomValues(r),i=0;i<r.length;i++)e[i]=255&r[i]}catch(t){}var n=0,s=function(){if(null==e[0]){for(e[0]=t,n=0;n<o.length;++n)e[0].update((new Date).getTime());for(e[0].update(this.STATE),n=0;n<h.length;n++)e[0].update(h[n]);this.STATE=e[0].finalize(),n=0}return e[0].next()};t.init(e);var o=[screen.width,screen.height,(new Date).getTime(),navigator.appVersion,navigator.userAgent],h=[];for(n=0;n<32;n++)h[n]=s();this.nextBytes=function(t){var e;for(e=0;e<t.length;++e)t[e]=s()}}function Y(){this.i=0,this.j=0,this.S=[]}function q(t){var e,i,r;for(e=0;e<256;++e)this.S[e]=e;for(i=0,e=0;e<256;++e)i=i+this.S[e]+t[e%t.length]&255,r=this.S[e],this.S[e]=this.S[i],this.S[i]=r;this.i=0,this.j=0}function G(){return this.S[this.i]}function C(t,e,i,r,n,s){for(var o=0,h=0;0!=n;){o=this.i=this.i+1&255,h=this.j=this.j+this.S[o]&255;var a=this.S[o];if(this.S[o]=this.S[h],this.S[h]=a,i[r++]^=this.S[a+this.S[o]&255],0==--n)return}}Y.prototype.init=q,Y.prototype.next=G,Y.prototype.encrypt=C;var W,_,X=256;function k(t,e){return e.toByteArray()}function Q(t,e){return e.signum()<=0||e.compareTo(t.n)>=0?new A(0):e}function Z(t,e){return t.exp(e,new N(t.m))}if(null==W){W=[],_=0;var J=void 0;if("undefined"!=typeof window&&window.crypto)if(window.crypto.getRandomValues){var $=new Uint8Array(32);for(window.crypto.getRandomValues($),J=0;J<32;++J)W[_++]=$[J]}else if("Netscape"==navigator.appName&&navigator.appVersion<"5"){var tt=window.crypto.random(32);for(J=0;J<tt.length;++J)W[_++]=255&tt.charCodeAt(J)}for(;_<X;)J=Math.floor(65536*Math.random()),W[_++]=J>>>8,W[_++]=255&J;_=0,function t(){if(null==W){for(t=new Y,_=0;_<o.length;++_)W[_]=255&Math.floor(256*Math.random());for(W[_]=(new Date).getTime(),_=(W[_]+1)%X;_<X;)W[_]=255&Math.floor(256*Math.random()),_=(_+1)%X;_=0}return W[_++]}()}function et(){if(null==this.n||null==this.e)return null;var t="";return t+=z(this.n.toString(16)),t+=z(this.e.toString(16))}function it(t,e){if(null!=t&&null!=e&&t.length>0&&e.length>0){var i=U(t,16),r=parseInt(e,16);this.setPublic(i,r)}else console.error("Invalid RSA public key")}function rt(t){return null!=t?t.modPowInt(this.e,this.n):null}function nt(t){var e=F(t,this.n.bitLength()+7>>3);if(null==e)return null;var i=this.doPublic(e);if(null==i)return null;var r=i.toString(16);return 0==(1&r.length)?r:"0"+r}j.prototype.doPublic=function(t){return t.modPowInt(this.e,this.n)},j.prototype.doPrivate=function(t){if(null==this.p||null==this.q)return t.modPow(this.d,this.n);for(var e=t.mod(this.p).modPow(this.dmp1,this.p),i=t.mod(this.q).modPow(this.dmq1,this.q);e.compareTo(i)<0;)e=e.add(this.p);return e.subtract(i).multiply(this.coeff).mod(this.p).multiply(this.q).add(i)},j.prototype.setPublic=H,j.prototype.encrypt=nt,j.prototype.setPrivate=function(t,e,i){null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=U(t,16),this.e=parseInt(e,16),this.d=U(i,16)):console.error("Invalid RSA private key")},j.prototype.setPrivateEx=function(t,e,i,r,n,s,o,h){null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=U(t,16),this.e=parseInt(e,16),this.d=U(i,16),this.p=U(r,16),this.q=U(n,16),this.dmp1=U(s,16),this.dmq1=U(o,16),this.coeff=U(h,16)):console.error("Invalid RSA private key")},j.prototype.generate=function(t,e){var i=new L,r=t>>1;this.e=parseInt(e,16);for(var n=new A(e,16);;){for(;this.p=new A(t-r,1,i),0!=this.p.subtract(A.ONE).gcd(n).compareTo(A.ONE)||!this.p.isProbablePrime(10););for(;this.q=new A(r,1,i),0!=this.q.subtract(A.ONE).gcd(n).compareTo(A.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var s=this.p;this.p=this.q,this.q=s}var o=this.p.subtract(A.ONE),h=this.q.subtract(A.ONE),a=o.multiply(h);if(0==a.gcd(n).compareTo(A.ONE)){this.n=this.p.multiply(this.q),this.d=n.modInverse(a),this.dmp1=this.d.mod(o),this.dmq1=this.d.mod(h),this.coeff=this.q.modInverse(this.p);break}}},j.prototype.decrypt=function(t){var e=U(t,16),i=this.doPrivate(e);return null==i?null:function(t,e){for(var i=t.toByteArray(),r=0;r<i.length&&0==i[r];)++r;if(i.length-r!=e-1||2!=i[r])return null;++r;for(;0!=i[r];)if(++r>=i.length)return null;var n="";for(;++r<i.length;){var s=255&i[r];s<128?n+=String.fromCharCode(s):s>191&&s<224?(n+=String.fromCharCode((31&s)<<6|63&i[r+1]),++r):(n+=String.fromCharCode((15&s)<<12|(63&i[r+1])<<6|63&i[r+2]),r+=2)}return n}(i,this.n.bitLength()+7>>3)},j.prototype.generateAsync=function(t,e,i){var r=new L,n=t>>1;this.e=parseInt(e,16);var s=new A(e,16),o=this,h=function(){var e=function(){if(o.p.compareTo(o.q)<=0){var t=o.p;o.p=o.q,o.q=t}var e=o.p.subtract(A.ONE),r=o.q.subtract(A.ONE),n=e.multiply(r);0==n.gcd(s).compareTo(A.ONE)?(o.n=o.p.multiply(o.q),o.d=s.modInverse(n),o.dmp1=o.d.mod(e),o.dmq1=o.d.mod(r),o.coeff=o.q.modInverse(o.p),setTimeout((function(){i()}),0)):setTimeout(h,0)},a=function(){o.q=new A(n,1,r),o.q.subtract(A.ONE).gcda(s,(function(t){0==t.compareTo(A.ONE)&&o.q.isProbablePrime(10)?setTimeout(e,0):setTimeout(a,0)}))},u=function(){o.p=new A(t-n,1,r),o.p.subtract(A.ONE).gcda(s,(function(t){0==t.compareTo(A.ONE)&&o.p.isProbablePrime(10)?setTimeout(a,0):setTimeout(u,0)}))};setTimeout(u,0)};setTimeout(h,0)},j.prototype.sign=function(t,e,i){var r=function(t,e){if(e<t.length+22)return console.error("Message too long for RSA"),null;for(var i=e-t.length-6,r="",n=0;n<i;n+=2)r+="ff";return U("0001"+r+"00"+t,16)}((st[i]||"")+e(t).toString(),this.n.bitLength()/4);if(null==r)return null;var n=this.doPrivate(r);if(null==n)return null;var s=n.toString(16);return 0==(1&s.length)?s:"0"+s},j.prototype.verify=function(t,e,i){var r=U(e,16),n=this.doPublic(r);return null==n?null:function(t){for(var e in st)if(st.hasOwnProperty(e)){var i=st[e],r=i.length;if(t.substr(0,r)==i)return t.substr(r)}return t}(n.toString(16).replace(/^1f+00/,""))==i(t).toString()};var st={md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",ripemd160:"3021300906052b2403020105000414"};var ot={};ot.lang={extend:function(t,e,i){if(!e||!t)throw new Error("YAHOO.lang.extend failed, please check that all dependencies are included.");var r=function(){};if(r.prototype=e.prototype,t.prototype=new r,(t.prototype.constructor=t).superclass=e.prototype,e.prototype.constructor==Object.prototype.constructor&&(e.prototype.constructor=e),i){var n;for(n in i)t.prototype[n]=i[n];var s=function(){},o=["toString","valueOf"];try{/MSIE/.test(navigator.userAgent)&&(s=function(t,e){for(n=0;n<o.length;n+=1){var i=o[n],r=e[i];"function"==typeof r&&r!=Object.prototype[i]&&(t[i]=r)}})}catch(t){}s(t.prototype,i)}}};var ht={};void 0!==ht.asn1&&ht.asn1||(ht.asn1={}),ht.asn1.ASN1Util=new function(){this.integerToByteHex=function(t){var e=t.toString(16);return e.length%2==1&&(e="0"+e),e},this.bigIntToMinTwosComplementsHex=function(t){var e=t.toString(16);if("-"!=e.substr(0,1))e.length%2==1?e="0"+e:e.match(/^[0-7]/)||(e="00"+e);else{var i=e.substr(1).length;i%2==1?i+=1:e.match(/^[0-7]/)||(i+=2);for(var r="",n=0;n<i;n++)r+="f";e=new A(r,16).xor(t).add(A.ONE).toString(16).replace(/^-/,"")}return e},this.getPEMStringFromHex=function(t,e){return hextopem(t,e)},this.newObject=function(t){var e=ht.asn1,i=e.DERBoolean,r=e.DERInteger,n=e.DERBitString,s=e.DEROctetString,o=e.DERNull,h=e.DERObjectIdentifier,a=e.DEREnumerated,u=e.DERUTF8String,c=e.DERNumericString,f=e.DERPrintableString,l=e.DERTeletexString,p=e.DERIA5String,g=e.DERUTCTime,d=e.DERGeneralizedTime,v=e.DERSequence,m=e.DERSet,y=e.DERTaggedObject,b=e.ASN1Util.newObject,T=Object.keys(t);if(1!=T.length)throw"key of param shall be only one.";var S=T[0];if(-1==":bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:seq:set:tag:".indexOf(":"+S+":"))throw"undefined key: "+S;if("bool"==S)return new i(t[S]);if("int"==S)return new r(t[S]);if("bitstr"==S)return new n(t[S]);if("octstr"==S)return new s(t[S]);if("null"==S)return new o(t[S]);if("oid"==S)return new h(t[S]);if("enum"==S)return new a(t[S]);if("utf8str"==S)return new u(t[S]);if("numstr"==S)return new c(t[S]);if("prnstr"==S)return new f(t[S]);if("telstr"==S)return new l(t[S]);if("ia5str"==S)return new p(t[S]);if("utctime"==S)return new g(t[S]);if("gentime"==S)return new d(t[S]);if("seq"==S){for(var E=t[S],w=[],D=0;D<E.length;D++){var x=b(E[D]);w.push(x)}return new v({array:w})}if("set"==S){for(E=t[S],w=[],D=0;D<E.length;D++){x=b(E[D]);w.push(x)}return new m({array:w})}if("tag"==S){var R=t[S];if("[object Array]"===Object.prototype.toString.call(R)&&3==R.length){var B=b(R[2]);return new y({tag:R[0],explicit:R[1],obj:B})}var O={};if(void 0!==R.explicit&&(O.explicit=R.explicit),void 0!==R.tag&&(O.tag=R.tag),void 0===R.obj)throw"obj shall be specified for 'tag'.";return O.obj=b(R.obj),new y(O)}},this.jsonToASN1HEX=function(t){return this.newObject(t).getEncodedHex()}},ht.asn1.ASN1Util.oidHexToInt=function(t){for(var e="",i=parseInt(t.substr(0,2),16),r=(e=Math.floor(i/40)+"."+i%40,""),n=2;n<t.length;n+=2){var s=("00000000"+parseInt(t.substr(n,2),16).toString(2)).slice(-8);if(r+=s.substr(1,7),"0"==s.substr(0,1))e=e+"."+new A(r,2).toString(10),r=""}return e},ht.asn1.ASN1Util.oidIntToHex=function(t){var e=function(t){var e=t.toString(16);return 1==e.length&&(e="0"+e),e},i=function(t){var i="",r=new A(t,10).toString(2),n=7-r.length%7;7==n&&(n=0);for(var s="",o=0;o<n;o++)s+="0";r=s+r;for(o=0;o<r.length-1;o+=7){var h=r.substr(o,7);o!=r.length-7&&(h="1"+h),i+=e(parseInt(h,2))}return i};if(!t.match(/^[0-9.]+$/))throw"malformed oid string: "+t;var r="",n=t.split("."),s=40*parseInt(n[0])+parseInt(n[1]);r+=e(s),n.splice(0,2);for(var o=0;o<n.length;o++)r+=i(n[o]);return r},ht.asn1.ASN1Object=function(){this.getLengthHexFromValue=function(){if(void 0===this.hV||null==this.hV)throw"this.hV is null or undefined.";if(this.hV.length%2==1)throw"value hex must be even length: n="+(""+this.hV.length)+",v="+this.hV;var t=this.hV.length/2,e=t.toString(16);if(e.length%2==1&&(e="0"+e),t<128)return e;var i=e.length/2;if(i>15)throw"ASN.1 length too long to represent by 8x: n = "+t.toString(16);return(128+i).toString(16)+e},this.getEncodedHex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getValueHex=function(){return this.getEncodedHex(),this.hV},this.getFreshValueHex=function(){return""}},ht.asn1.DERAbstractString=function(t){ht.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(t){this.hTLV=null,this.isModified=!0,this.s=t,this.hV=stohex(this.s)},this.setStringHex=function(t){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.getFreshValueHex=function(){return this.hV},void 0!==t&&("string"==typeof t?this.setString(t):void 0!==t.str?this.setString(t.str):void 0!==t.hex&&this.setStringHex(t.hex))},ot.lang.extend(ht.asn1.DERAbstractString,ht.asn1.ASN1Object),ht.asn1.DERAbstractTime=function(t){ht.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(t){return utc=t.getTime()+6e4*t.getTimezoneOffset(),new Date(utc)},this.formatDate=function(t,e,i){var r=this.zeroPadding,n=this.localDateToUTC(t),s=String(n.getFullYear());"utc"==e&&(s=s.substr(2,2));var o=s+r(String(n.getMonth()+1),2)+r(String(n.getDate()),2)+r(String(n.getHours()),2)+r(String(n.getMinutes()),2)+r(String(n.getSeconds()),2);if(!0===i){var h=n.getMilliseconds();if(0!=h){var a=r(String(h),3);o=o+"."+(a=a.replace(/[0]+$/,""))}}return o+"Z"},this.zeroPadding=function(t,e){return t.length>=e?t:new Array(e-t.length+1).join("0")+t},this.getString=function(){return this.s},this.setString=function(t){this.hTLV=null,this.isModified=!0,this.s=t,this.hV=stohex(t)},this.setByDateValue=function(t,e,i,r,n,s){var o=new Date(Date.UTC(t,e-1,i,r,n,s,0));this.setByDate(o)},this.getFreshValueHex=function(){return this.hV}},ot.lang.extend(ht.asn1.DERAbstractTime,ht.asn1.ASN1Object),ht.asn1.DERAbstractStructured=function(t){ht.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(t){this.hTLV=null,this.isModified=!0,this.asn1Array=t},this.appendASN1Object=function(t){this.hTLV=null,this.isModified=!0,this.asn1Array.push(t)},this.asn1Array=new Array,void 0!==t&&void 0!==t.array&&(this.asn1Array=t.array)},ot.lang.extend(ht.asn1.DERAbstractStructured,ht.asn1.ASN1Object),ht.asn1.DERBoolean=function(){ht.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV="0101ff"},ot.lang.extend(ht.asn1.DERBoolean,ht.asn1.ASN1Object),ht.asn1.DERInteger=function(t){ht.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.setByBigInteger=function(t){this.hTLV=null,this.isModified=!0,this.hV=ht.asn1.ASN1Util.bigIntToMinTwosComplementsHex(t)},this.setByInteger=function(t){var e=new A(String(t),10);this.setByBigInteger(e)},this.setValueHex=function(t){this.hV=t},this.getFreshValueHex=function(){return this.hV},void 0!==t&&(void 0!==t.bigint?this.setByBigInteger(t.bigint):void 0!==t.int?this.setByInteger(t.int):"number"==typeof t?this.setByInteger(t):void 0!==t.hex&&this.setValueHex(t.hex))},ot.lang.extend(ht.asn1.DERInteger,ht.asn1.ASN1Object),ht.asn1.DERBitString=function(t){if(void 0!==t&&void 0!==t.obj){var e=ht.asn1.ASN1Util.newObject(t.obj);t.hex="00"+e.getEncodedHex()}ht.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(t){this.hTLV=null,this.isModified=!0,this.hV=t},this.setUnusedBitsAndHexValue=function(t,e){if(t<0||7<t)throw"unused bits shall be from 0 to 7: u = "+t;var i="0"+t;this.hTLV=null,this.isModified=!0,this.hV=i+e},this.setByBinaryString=function(t){var e=8-(t=t.replace(/0+$/,"")).length%8;8==e&&(e=0);for(var i=0;i<=e;i++)t+="0";var r="";for(i=0;i<t.length-1;i+=8){var n=t.substr(i,8),s=parseInt(n,2).toString(16);1==s.length&&(s="0"+s),r+=s}this.hTLV=null,this.isModified=!0,this.hV="0"+e+r},this.setByBooleanArray=function(t){for(var e="",i=0;i<t.length;i++)1==t[i]?e+="1":e+="0";this.setByBinaryString(e)},this.newFalseArray=function(t){for(var e=new Array(t),i=0;i<t;i++)e[i]=!1;return e},this.getFreshValueHex=function(){return this.hV},void 0!==t&&("string"==typeof t&&t.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(t):void 0!==t.hex?this.setHexValueIncludingUnusedBits(t.hex):void 0!==t.bin?this.setByBinaryString(t.bin):void 0!==t.array&&this.setByBooleanArray(t.array))},ot.lang.extend(ht.asn1.DERBitString,ht.asn1.ASN1Object),ht.asn1.DEROctetString=function(t){if(void 0!==t&&void 0!==t.obj){var e=ht.asn1.ASN1Util.newObject(t.obj);t.hex=e.getEncodedHex()}ht.asn1.DEROctetString.superclass.constructor.call(this,t),this.hT="04"},ot.lang.extend(ht.asn1.DEROctetString,ht.asn1.DERAbstractString),ht.asn1.DERNull=function(){ht.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},ot.lang.extend(ht.asn1.DERNull,ht.asn1.ASN1Object),ht.asn1.DERObjectIdentifier=function(t){var e=function(t){var e=t.toString(16);return 1==e.length&&(e="0"+e),e},i=function(t){var i="",r=new A(t,10).toString(2),n=7-r.length%7;7==n&&(n=0);for(var s="",o=0;o<n;o++)s+="0";r=s+r;for(o=0;o<r.length-1;o+=7){var h=r.substr(o,7);o!=r.length-7&&(h="1"+h),i+=e(parseInt(h,2))}return i};ht.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(t){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.setValueOidString=function(t){if(!t.match(/^[0-9.]+$/))throw"malformed oid string: "+t;var r="",n=t.split("."),s=40*parseInt(n[0])+parseInt(n[1]);r+=e(s),n.splice(0,2);for(var o=0;o<n.length;o++)r+=i(n[o]);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=r},this.setValueName=function(t){var e=ht.asn1.x509.OID.name2oid(t);if(""===e)throw"DERObjectIdentifier oidName undefined: "+t;this.setValueOidString(e)},this.getFreshValueHex=function(){return this.hV},void 0!==t&&("string"==typeof t?t.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(t):this.setValueName(t):void 0!==t.oid?this.setValueOidString(t.oid):void 0!==t.hex?this.setValueHex(t.hex):void 0!==t.name&&this.setValueName(t.name))},ot.lang.extend(ht.asn1.DERObjectIdentifier,ht.asn1.ASN1Object),ht.asn1.DEREnumerated=function(t){ht.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(t){this.hTLV=null,this.isModified=!0,this.hV=ht.asn1.ASN1Util.bigIntToMinTwosComplementsHex(t)},this.setByInteger=function(t){var e=new A(String(t),10);this.setByBigInteger(e)},this.setValueHex=function(t){this.hV=t},this.getFreshValueHex=function(){return this.hV},void 0!==t&&(void 0!==t.int?this.setByInteger(t.int):"number"==typeof t?this.setByInteger(t):void 0!==t.hex&&this.setValueHex(t.hex))},ot.lang.extend(ht.asn1.DEREnumerated,ht.asn1.ASN1Object),ht.asn1.DERUTF8String=function(t){ht.asn1.DERUTF8String.superclass.constructor.call(this,t),this.hT="0c"},ot.lang.extend(ht.asn1.DERUTF8String,ht.asn1.DERAbstractString),ht.asn1.DERNumericString=function(t){ht.asn1.DERNumericString.superclass.constructor.call(this,t),this.hT="12"},ot.lang.extend(ht.asn1.DERNumericString,ht.asn1.DERAbstractString),ht.asn1.DERPrintableString=function(t){ht.asn1.DERPrintableString.superclass.constructor.call(this,t),this.hT="13"},ot.lang.extend(ht.asn1.DERPrintableString,ht.asn1.DERAbstractString),ht.asn1.DERTeletexString=function(t){ht.asn1.DERTeletexString.superclass.constructor.call(this,t),this.hT="14"},ot.lang.extend(ht.asn1.DERTeletexString,ht.asn1.DERAbstractString),ht.asn1.DERIA5String=function(t){ht.asn1.DERIA5String.superclass.constructor.call(this,t),this.hT="16"},ot.lang.extend(ht.asn1.DERIA5String,ht.asn1.DERAbstractString),ht.asn1.DERUTCTime=function(t){ht.asn1.DERUTCTime.superclass.constructor.call(this,t),this.hT="17",this.setByDate=function(t){this.hTLV=null,this.isModified=!0,this.date=t,this.s=this.formatDate(this.date,"utc"),this.hV=stohex(this.s)},this.getFreshValueHex=function(){return void 0===this.date&&void 0===this.s&&(this.date=new Date,this.s=this.formatDate(this.date,"utc"),this.hV=stohex(this.s)),this.hV},void 0!==t&&(void 0!==t.str?this.setString(t.str):"string"==typeof t&&t.match(/^[0-9]{12}Z$/)?this.setString(t):void 0!==t.hex?this.setStringHex(t.hex):void 0!==t.date&&this.setByDate(t.date))},ot.lang.extend(ht.asn1.DERUTCTime,ht.asn1.DERAbstractTime),ht.asn1.DERGeneralizedTime=function(t){ht.asn1.DERGeneralizedTime.superclass.constructor.call(this,t),this.hT="18",this.withMillis=!1,this.setByDate=function(t){this.hTLV=null,this.isModified=!0,this.date=t,this.s=this.formatDate(this.date,"gen",this.withMillis),this.hV=stohex(this.s)},this.getFreshValueHex=function(){return void 0===this.date&&void 0===this.s&&(this.date=new Date,this.s=this.formatDate(this.date,"gen",this.withMillis),this.hV=stohex(this.s)),this.hV},void 0!==t&&(void 0!==t.str?this.setString(t.str):"string"==typeof t&&t.match(/^[0-9]{14}Z$/)?this.setString(t):void 0!==t.hex?this.setStringHex(t.hex):void 0!==t.date&&this.setByDate(t.date),!0===t.millis&&(this.withMillis=!0))},ot.lang.extend(ht.asn1.DERGeneralizedTime,ht.asn1.DERAbstractTime),ht.asn1.DERSequence=function(t){ht.asn1.DERSequence.superclass.constructor.call(this,t),this.hT="30",this.getFreshValueHex=function(){for(var t="",e=0;e<this.asn1Array.length;e++){t+=this.asn1Array[e].getEncodedHex()}return this.hV=t,this.hV}},ot.lang.extend(ht.asn1.DERSequence,ht.asn1.DERAbstractStructured),ht.asn1.DERSet=function(t){ht.asn1.DERSet.superclass.constructor.call(this,t),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var t=new Array,e=0;e<this.asn1Array.length;e++){var i=this.asn1Array[e];t.push(i.getEncodedHex())}return 1==this.sortFlag&&t.sort(),this.hV=t.join(""),this.hV},void 0!==t&&void 0!==t.sortflag&&0==t.sortflag&&(this.sortFlag=!1)},ot.lang.extend(ht.asn1.DERSet,ht.asn1.DERAbstractStructured),ht.asn1.DERTaggedObject=function(t){ht.asn1.DERTaggedObject.superclass.constructor.call(this),this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.setASN1Object=function(t,e,i){this.hT=e,this.isExplicit=t,this.asn1Object=i,this.isExplicit?(this.hV=this.asn1Object.getEncodedHex(),this.hTLV=null,this.isModified=!0):(this.hV=null,this.hTLV=i.getEncodedHex(),this.hTLV=this.hTLV.replace(/^../,e),this.isModified=!1)},this.getFreshValueHex=function(){return this.hV},void 0!==t&&(void 0!==t.tag&&(this.hT=t.tag),void 0!==t.explicit&&(this.isExplicit=t.explicit),void 0!==t.obj&&(this.asn1Object=t.obj,this.setASN1Object(this.isExplicit,this.hT,this.asn1Object)))},ot.lang.extend(ht.asn1.DERTaggedObject,ht.asn1.ASN1Object);var at=function(t){function e(i){var r=t.call(this)||this;return i&&("string"==typeof i?r.parseKey(i):(e.hasPrivateKeyProperty(i)||e.hasPublicKeyProperty(i))&&r.parsePropertiesFrom(i)),r}return function(t,e){function i(){this.constructor=t}c(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}(e,t),e.prototype.parseKey=function(t){try{var e=0,i=0,r=/^\s*(?:[0-9A-Fa-f][0-9A-Fa-f]\s*)+$/.test(t)?d(t):v.unarmor(t),n=x.decode(r);if(3===n.sub.length&&(n=n.sub[2].sub[0]),9===n.sub.length){e=n.sub[1].getHexStringValue(),this.n=U(e,16),i=n.sub[2].getHexStringValue(),this.e=parseInt(i,16);var s=n.sub[3].getHexStringValue();this.d=U(s,16);var o=n.sub[4].getHexStringValue();this.p=U(o,16);var h=n.sub[5].getHexStringValue();this.q=U(h,16);var a=n.sub[6].getHexStringValue();this.dmp1=U(a,16);var u=n.sub[7].getHexStringValue();this.dmq1=U(u,16);var c=n.sub[8].getHexStringValue();this.coeff=U(c,16)}else{if(2!==n.sub.length)return!1;var f=n.sub[1].sub[0];e=f.sub[0].getHexStringValue(),this.n=U(e,16),i=f.sub[1].getHexStringValue(),this.e=parseInt(i,16)}return!0}catch(t){return!1}},e.prototype.getPrivateBaseKey=function(){var t={array:[new ht.asn1.DERInteger({int:0}),new ht.asn1.DERInteger({bigint:this.n}),new ht.asn1.DERInteger({int:this.e}),new ht.asn1.DERInteger({bigint:this.d}),new ht.asn1.DERInteger({bigint:this.p}),new ht.asn1.DERInteger({bigint:this.q}),new ht.asn1.DERInteger({bigint:this.dmp1}),new ht.asn1.DERInteger({bigint:this.dmq1}),new ht.asn1.DERInteger({bigint:this.coeff})]};return new ht.asn1.DERSequence(t).getEncodedHex()},e.prototype.getPrivateBaseKeyB64=function(){return p(this.getPrivateBaseKey())},e.prototype.getPublicBaseKey=function(){var t=new ht.asn1.DERSequence({array:[new ht.asn1.DERObjectIdentifier({oid:"1.2.840.113549.1.1.1"}),new ht.asn1.DERNull]}),e=new ht.asn1.DERSequence({array:[new ht.asn1.DERInteger({bigint:this.n}),new ht.asn1.DERInteger({int:this.e})]}),i=new ht.asn1.DERBitString({hex:"00"+e.getEncodedHex()});return new ht.asn1.DERSequence({array:[t,i]}).getEncodedHex()},e.prototype.getPublicBaseKeyB64=function(){return p(this.getPublicBaseKey())},e.wordwrap=function(t,e){if(!t)return t;var i="(.{1,"+(e=e||64)+"})( +|$\n?)|(.{1,"+e+"})";return t.match(RegExp(i,"g")).join("\n")},e.prototype.getPrivateKey=function(){var t="-----BEGIN RSA PRIVATE KEY-----\n";return t+=e.wordwrap(this.getPrivateBaseKeyB64())+"\n",t+="-----END RSA PRIVATE KEY-----"},e.prototype.getPublicKey=function(){var t="-----BEGIN PUBLIC KEY-----\n";return t+=e.wordwrap(this.getPublicBaseKeyB64())+"\n",t+="-----END PUBLIC KEY-----"},e.hasPublicKeyProperty=function(t){return(t=t||{}).hasOwnProperty("n")&&t.hasOwnProperty("e")},e.hasPrivateKeyProperty=function(t){return(t=t||{}).hasOwnProperty("n")&&t.hasOwnProperty("e")&&t.hasOwnProperty("d")&&t.hasOwnProperty("p")&&t.hasOwnProperty("q")&&t.hasOwnProperty("dmp1")&&t.hasOwnProperty("dmq1")&&t.hasOwnProperty("coeff")},e.prototype.parsePropertiesFrom=function(t){this.n=t.n,this.e=t.e,t.hasOwnProperty("d")&&(this.d=t.d,this.p=t.p,this.q=t.q,this.dmp1=t.dmp1,this.dmq1=t.dmq1,this.coeff=t.coeff)},e}(j),ut=function(){function t(t){t=t||{},this.default_key_size=t.default_key_size?parseInt(t.default_key_size,10):1024,this.default_public_exponent=t.default_public_exponent||"010001",this.log=t.log||!1,this.key=null}return t.prototype.setKey=function(t){this.log&&this.key&&console.warn("A key was already set, overriding existing."),this.key=new at(t)},t.prototype.setPrivateKey=function(t){this.setKey(t)},t.prototype.setPublicKey=function(t){this.setKey(t)},t.prototype.decrypt=function(t){try{return this.getKey().decrypt(g(t))}catch(t){return!1}},t.prototype.encrypt=function(t){try{return p(this.getKey().encrypt(t))}catch(t){return!1}},t.prototype.sign=function(t,e,i){try{return p(this.getKey().sign(t,e,i))}catch(t){return!1}},t.prototype.verify=function(t,e,i){try{return this.getKey().verify(t,g(e),i)}catch(t){return!1}},t.prototype.getKey=function(t){if(!this.key){if(this.key=new at,t&&"[object Function]"==={}.toString.call(t))return void this.key.generateAsync(this.default_key_size,this.default_public_exponent,t);this.key.generate(this.default_key_size,this.default_public_exponent)}return this.key},t.prototype.getPrivateKey=function(){return this.getKey().getPrivateKey()},t.prototype.getPrivateKeyB64=function(){return this.getKey().getPrivateBaseKeyB64()},t.prototype.getPublicKey=function(){return this.getKey().getPublicKey()},t.prototype.getPublicKeyB64=function(){return this.getKey().getPublicBaseKeyB64()},t.version="3.3.2",t}();window.JSEncrypt=ut,e=ut})(),r})()));
    </script>
    <style>
:root {
    --primary-color: #3b82f6;
    --primary-hover: #2563eb;
    --background: #ffffff;
    --surface: #f8fafc;
    --border: #e2e8f0;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
    --info: #3b82f6;
    --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --radius: 0.5rem;
    --color-blue: #3b82f6;
    --color-cyan: #06b6d4;
    --color-dark: #1e293b;
    --color-grape: #8b5cf6;
    --color-gray: #6b7280;
    --color-green: #10b981;
    --color-indigo: #6366f1;
    --color-lime: #84cc16;
    --color-orange: #f97316;
    --color-pink: #ec4899;
    --color-red: #ef4444;
    --color-teal: #14b8a6;
    --color-violet: #8b5cf6;
    --color-yellow: #eab308;
}

.dark-theme {
    --background: #0f172a;
    --surface: #1e293b;
    --border: #334155;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-muted: #94a3b8;
    --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    background-color: var(--background);
    color: var(--text-primary);
    line-height: 1.6;
    transition: background-color 0.3s ease, color 0.3s ease;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.container {
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: 20px;
    flex: 1;
    box-sizing: border-box;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 20px;
}

.logo {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary-color);
    display: flex;
    align-items: center;
}

.brand-logo {
    height: 32px;
    width: auto;
    margin-right: 12px;
    border-radius: 4px;
}

.controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

.btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.btn:hover { background: var(--border); }
.btn-primary { background: var(--primary-color); color: white; border-color: var(--primary-color); }
.btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-icon { padding: 8px; min-width: 40px; justify-content: center; }


.card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 20px;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}

.card-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header.clickable { cursor: pointer; transition: background 0.2s ease; }
.card-header.clickable:hover { background: rgba(0,0,0,0.02); }
.dark-theme .card-header.clickable:hover { background: rgba(255,255,255,0.02); }

.card-content { padding: 20px; width: 100%; box-sizing: border-box; min-width: 0; overflow: hidden; }

/* User Info - Original cards style with info-row */
.user-info .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}
.user-info .info-row:last-child { border-bottom: none; }
.user-info .info-label { color: var(--text-secondary); font-weight: 500; }
.user-info .info-value { color: var(--text-primary); font-weight: 600; text-align: right; word-break: break-word; }

/* Subscription Info Block - Collapsed */
.user-info-collapsed {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.user-info-collapsed:hover { background: rgba(0,0,0,0.02); }
.dark-theme .user-info-collapsed:hover { background: rgba(255,255,255,0.02); }
.user-info-collapsed .status-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.user-info-collapsed .status-icon.active { background: var(--success); color: white; }
.user-info-collapsed .status-icon.inactive { background: var(--error); color: white; }
.user-info-collapsed .user-summary { flex: 1; }
.user-info-collapsed .user-summary-name { font-weight: 600; font-size: 18px; }
.user-info-collapsed .user-summary-expire { color: var(--text-secondary); font-size: 14px; }
.user-info-collapsed .expand-icon { color: var(--text-muted); transition: transform 0.2s ease; }
.user-info-collapsed.expanded .expand-icon { transform: rotate(180deg); }
.user-info-collapsed-details { display: none; padding: 0 20px 20px; }
.user-info-collapsed-details.open { display: block; }

/* Subscription Info Block - Expanded */
.user-info-expanded .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}
.user-info-expanded .info-row:last-child { border-bottom: none; }
.user-info-expanded .info-label { color: var(--text-secondary); font-weight: 500; }
.user-info-expanded .info-value { color: var(--text-primary); font-weight: 600; text-align: right; word-break: break-word; }

/* Stats Grid */
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.stat-card {
    background: linear-gradient(135deg, var(--surface) 0%, rgba(59, 130, 246, 0.05) 100%);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
}
.stat-card-label { color: var(--text-secondary); font-size: 12px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
.stat-card-value { font-weight: 600; }

.badge { padding: 4px 8px; border-radius: 9999px; font-size: 12px; font-weight: 500; text-transform: uppercase; }
.badge-active { background: #dcfce7; color: #166534; }
.badge-disabled, .badge-limited, .badge-expired { background: #fee2e2; color: #991b1b; }
.dark-theme .badge-active { background: #14532d; color: #bbf7d0; }
.dark-theme .badge-disabled, .dark-theme .badge-limited, .dark-theme .badge-expired { background: #7f1d1d; color: #fecaca; }

/* Links Section */
.links-section { margin-bottom: 0; }
.links-section .card-content { display: none; }
.links-section.open .card-content { display: block; }
.links-section .expand-icon { transition: transform 0.2s ease; }
.links-section.open .expand-icon { transform: rotate(180deg); }

.link-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 12px;
    background: var(--surface);
}
.link-item:last-child { margin-bottom: 0; }
.link-info { flex: 1; min-width: 0; }
.link-name {
    font-weight: 500;
    word-break: break-word;
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: "Twemoji Country Flags", system-ui, -apple-system, Roboto, "Segoe UI", "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
}
.link-actions { display: flex; gap: 8px; }

/* Installation Section */
.apps-section { margin-bottom: 20px; width: 100%; min-width: 0; box-sizing: border-box; }
#appsContainer { width: 100%; min-width: 0; box-sizing: border-box; }
.platform-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    background: var(--surface);
    padding: 4px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    flex-wrap: nowrap;
    overflow-x: auto;
}
.platform-tab {
    flex: 1 0 auto;
    padding: 8px 16px;
    text-align: center;
    border-radius: calc(var(--radius) - 2px);
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-width: 80px;
}
.platform-tab:hover { background: var(--border); }
.platform-tab.active { background: var(--primary-color); color: white; }
.platform-tab svg { color: inherit; }
#platform-selector-btn { display: none; }

/* App Cards Container */
.apps-container { display: flex; flex-direction: column; gap: 20px; width: 100%; min-width: 0; box-sizing: border-box; }
.featured-apps-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; width: 100%; min-width: 0; box-sizing: border-box; }

.other-apps-spoiler { width: 100%; }
.spoiler-header {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
    font-weight: 500;
    width: 100%;
}
.spoiler-header:hover { background: var(--border); }
.spoiler-content { display: none; margin-top: 8px; }
.spoiler-content.open { display: block; }
.spoiler-arrow { transition: transform 0.2s ease; flex-shrink: 0; }
.spoiler-arrow.open { transform: rotate(180deg); }
.apps-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; width: 100%; min-width: 0; box-sizing: border-box; }

.app-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}
.app-card:hover { border-color: var(--primary-color); box-shadow: var(--shadow-lg); }
.app-card.featured {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, var(--surface) 0%, rgba(59, 130, 246, 0.05) 100%);
}
.app-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.app-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius);
    background: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}
.app-icon svg { width: 24px; height: 24px; }
.app-name { font-weight: 600; font-size: 16px; }
.featured-badge {
    position: absolute;
    top: -1px;
    right: -1px;
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: 0 var(--radius) 0 var(--radius);
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
}

/* App Tabs for non-minimal modes */
.app-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}
.app-tab {
    flex: 1 1 auto;
    min-width: 140px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    display: flex;
    align-items: stretch;
    position: relative;
    overflow: hidden;
    box-sizing: border-box;
}
.app-tab:hover { border-color: var(--primary-color); }
.app-tab.active {
    border-color: var(--primary-color);
    background: var(--primary-color);
    color: white;
}
.app-tab .star-icon {
    color: var(--primary-color);
    position: absolute;
    top: 4px;
    left: 4px;
    width: 12px;
    height: 12px;
    z-index: 1;
}
.app-tab.active .star-icon { color: white; }
.app-tab .app-tab-icon {
    width: 48px;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    order: 2;
    border-radius: calc(var(--radius) - 1px) 0 0 calc(var(--radius) - 1px);
}
.app-tab .app-tab-icon svg { width: 32px; height: 32px; }
.app-tab .app-tab-name {
    order: 1;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

@media (max-width: 768px) {
    .app-tab {
        flex: 1 0 calc(50% - 4px);
        min-width: fit-content;
    }
    .app-tab .app-tab-name {
        overflow: visible;
        text-overflow: clip;
    }
}

/* Installation Guides - Cards */
.guides-cards { width: 100%; min-width: 0; box-sizing: border-box; }
.guides-cards .guide-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    overflow: hidden;
    word-break: break-word;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}
.guides-cards .guide-card:last-child { margin-bottom: 0; }
.guides-cards .guide-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}
.guides-cards .guide-card-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.guides-cards .guide-card-icon svg { width: 20px; height: 20px; }
.guides-cards .guide-card-title { font-weight: 600; font-size: 16px; }
.guides-cards .guide-card-description { color: var(--text-secondary); margin-bottom: 16px; word-break: break-word; }
.guides-cards .guide-card-buttons { display: flex; flex-wrap: wrap; gap: 8px; }

/* Installation Guides - Accordion */
.guides-accordion { width: 100%; min-width: 0; box-sizing: border-box; }
.guides-accordion .accordion-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 8px;
    overflow: hidden;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}
.guides-accordion .accordion-item:last-child { margin-bottom: 0; }
.guides-accordion .accordion-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    cursor: pointer;
    transition: background 0.2s ease;
    width: 100%;
}
.guides-accordion .accordion-header:hover { background: rgba(0,0,0,0.02); }
.dark-theme .guides-accordion .accordion-header:hover { background: rgba(255,255,255,0.02); }
.guides-accordion .accordion-icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.guides-accordion .accordion-icon svg { width: 18px; height: 18px; }
.guides-accordion .accordion-title { flex: 1; font-weight: 500; }
.guides-accordion .accordion-arrow { color: var(--text-muted); transition: transform 0.2s ease; }
.guides-accordion .accordion-item.open .accordion-arrow { transform: rotate(180deg); }
.guides-accordion .accordion-content {
    display: none;
    padding: 0 16px 16px;
    border-top: 1px solid var(--border);
    overflow: hidden;
    word-break: break-word;
}
.guides-accordion .accordion-item.open .accordion-content { display: block; padding-top: 16px; }
.guides-accordion .accordion-description { color: var(--text-secondary); margin-bottom: 12px; word-break: break-word; }
.guides-accordion .accordion-buttons { display: flex; flex-wrap: wrap; gap: 8px; }

/* Installation Guides - Expanded (always open, no toggle) */
.guides-expanded { width: 100%; min-width: 0; box-sizing: border-box; }
.guides-expanded .expanded-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 8px;
    overflow: hidden;
    word-break: break-word;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}
.guides-expanded .expanded-item:last-child { margin-bottom: 0; }
.guides-expanded .expanded-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
}
.guides-expanded .expanded-icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.guides-expanded .expanded-icon svg { width: 18px; height: 18px; }
.guides-expanded .expanded-title { flex: 1; font-weight: 500; }
.guides-expanded .expanded-content {
    padding: 0 16px 16px;
    border-top: 1px solid var(--border);
    padding-top: 16px;
    overflow: hidden;
    word-break: break-word;
}
.guides-expanded .expanded-description { color: var(--text-secondary); margin-bottom: 12px; word-break: break-word; }
.guides-expanded .expanded-buttons { display: flex; flex-wrap: wrap; gap: 8px; }

/* Installation Guides - Minimal (steps in modal) */
.guides-minimal { width: 100%; min-width: 0; box-sizing: border-box; }
.guides-minimal .step { margin-bottom: 24px; width: 100%; min-width: 0; box-sizing: border-box; }
.guides-minimal .step:last-child { margin-bottom: 0; }
.guides-minimal .step-title {
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.guides-minimal .step-number {
    background: var(--primary-color);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    flex-shrink: 0;
}
.guides-minimal .step-description { color: var(--text-secondary); margin-bottom: 12px; word-break: break-word; }
.guides-minimal .step-buttons { display: flex; flex-wrap: wrap; gap: 8px; }

/* Installation Guides - Timeline */
.guides-timeline { position: relative; width: 100%; min-width: 0; box-sizing: border-box; }
.guides-timeline .timeline-container { position: relative; width: 100%; min-width: 0; box-sizing: border-box; }
.guides-timeline .timeline-step {
    position: relative;
    margin-bottom: 24px;
    display: none;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}
.guides-timeline .timeline-step.active { display: block; }
.guides-timeline .timeline-step-content {
    overflow: hidden;
    word-break: break-word;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}
.guides-timeline .timeline-step-content.guide-card { margin-bottom: 0; }
.guides-timeline .timeline-step-content .guide-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.guides-timeline .timeline-step-content .app-tabs { margin-bottom: 0; }
.guides-timeline .timeline-step-content .guide-card-icon { width: 40px; height: 40px; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.guides-timeline .timeline-step-content .guide-card-icon svg { width: 20px; height: 20px; }
.guides-timeline .timeline-step-content .guide-card-title { font-weight: 600; font-size: 16px; }
.guides-timeline .timeline-step-content .guide-card-description { color: var(--text-secondary); margin-bottom: 16px; word-break: break-word; }
.guides-timeline .timeline-step-content .guide-card-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
.guides-timeline .timeline-nav {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    margin-top: 0;
}
.guides-timeline .timeline-nav .btn { flex: 1; justify-content: center; gap: 8px; }
.guides-timeline .timeline-nav .nav-step-icon { display: flex; align-items: center; }
.guides-timeline .timeline-nav .nav-step-icon svg { width: 16px; height: 16px; }
.guides-timeline .timeline-dots {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 20px;
    padding: 8px 0;
}
.guides-timeline .timeline-dot {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}
.guides-timeline .timeline-dot svg { width: 16px; height: 16px; }
.guides-timeline .timeline-dot.active { transform: scale(1.3); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.guides-timeline .timeline-dot.completed { opacity: 0.6; }

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    padding-top: env(safe-area-inset-top, 20px);
    padding-bottom: env(safe-area-inset-bottom, 20px);
}
.dark-theme .modal {
    background: rgba(15, 23, 42, 0.9);
}
.modal.active { display: flex; }
.modal-content {
    background: var(--surface);
    border-radius: var(--radius);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border);
}
.modal-title {
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: "Twemoji Country Flags", system-ui, -apple-system, Roboto, "Segoe UI", "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
}
.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
}
.modal-close:hover { background: var(--border); }
.modal-body { padding: 20px; }

/* Step (for modal) */
.step { margin-bottom: 24px; }
.step:last-child { margin-bottom: 0; }
.step-title { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.step-number {
    background: var(--primary-color);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    flex-shrink: 0;
}
.step-description { color: var(--text-secondary); margin-bottom: 12px; }
.step-buttons { display: flex; flex-wrap: wrap; gap: 8px; }

/* Platform Modal */
.platform-modal-list { display: flex; flex-direction: column; gap: 8px; }
.platform-modal-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s ease;
}
.platform-modal-item:hover { background: var(--border); border-color: var(--primary-color); }

/* Settings Modal */
.settings-section { margin-bottom: 24px; }
.settings-section:last-child { margin-bottom: 0; }
.settings-label { font-weight: 600; margin-bottom: 12px; display: block; }
.settings-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.settings-buttons .btn {
    flex: 1 1 auto;
    min-width: 0;
    justify-content: center;
}
.lang-emoji {
    font-family: "Twemoji Country Flags", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
    font-size: 1.2em;
}

/* QR Modal */
.qr-container { display: flex; flex-direction: column; align-items: center; padding: 20px; }
.qr-container > div { width: 256px; height: 256px; display: flex; align-items: center; justify-content: center; }
.qr-container img { width: 256px; height: 256px; border-radius: var(--radius); }
.qr-hint { margin-top: 16px; color: var(--text-secondary); text-align: center; }

/* Footer */
.footer {
    text-align: center;
    padding: 20px;
    color: var(--text-muted);
    font-size: 14px;
    border-top: 1px solid var(--border);
    margin-top: auto;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--text-primary);
    color: var(--background);
    padding: 12px 24px;
    border-radius: var(--radius);
    font-weight: 500;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 2000;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* SVG Icon sizing */
.icon-svg { width: 20px; height: 20px; display: inline-block; vertical-align: middle; }
.icon-svg-sm { width: 16px; height: 16px; }
.icon-svg-lg { width: 24px; height: 24px; }
.w-4 { width: 16px; }
.h-4 { height: 16px; }
.w-5 { width: 20px; }
.h-5 { height: 20px; }
.w-6 { width: 24px; }
.h-6 { height: 24px; }

/* Responsive */
@media (max-width: 768px) {
    .container { padding: 16px; width: 100%; box-sizing: border-box; }
    .header { gap: 12px; }
    .logo { font-size: 20px; flex: 1; }
    .controls { gap: 8px; }
    .btn-text { display: none; }
    .btn-icon { padding: 8px; min-width: auto; }
    .stats-grid { grid-template-columns: 1fr; }
    .featured-apps-row { grid-template-columns: 1fr; }
    .apps-grid { grid-template-columns: 1fr; }
    .app-card { width: 100%; min-width: 0; box-sizing: border-box; }
    .card { width: 100%; min-width: 0; box-sizing: border-box; }
    .card-content { width: 100%; min-width: 0; box-sizing: border-box; }
    .apps-container { width: 100%; min-width: 0; box-sizing: border-box; }
    .guides-cards, .guides-accordion, .guides-expanded, .guides-minimal, .guides-timeline { width: 100%; min-width: 0; box-sizing: border-box; }
    .app-tabs { width: 100%; min-width: 0; box-sizing: border-box; }
}

/* Platform tabs breakpoint - show selector button instead of tabs on screens <= 1024px */
@media (max-width: 1024px) {
    .platform-tabs { display: none; }
    #platform-selector-btn { display: inline-flex !important; }
}

/* Скрываем элементы до загрузки данных */
.logo:not(.loaded) { visibility: hidden; }
.header-controls:not(.loaded) { visibility: hidden; }
#mainContent { opacity: 0; transition: opacity 0.2s ease; }
#mainContent.loaded { opacity: 1; }

/* Snowflakes Animation */
.snowflakes {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
    overflow: hidden;
}
.snowflake {
    position: absolute;
    top: -20px;
    color: #a0c4e8;
    font-size: 1em;
    text-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
    animation: snowfall linear infinite;
    opacity: 0;
}
.dark-theme .snowflake {
    color: #fff;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
}
@keyframes snowfall {
    0% { transform: translateY(0) rotate(0deg); opacity: 0; }
    3% { opacity: 0.9; }
    95% { opacity: 0.9; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}
.snowflake:nth-child(1) { left: 5%; animation-duration: 8s; animation-delay: 0s; font-size: 0.8em; }
.snowflake:nth-child(2) { left: 15%; animation-duration: 12s; animation-delay: 1s; font-size: 1.2em; }
.snowflake:nth-child(3) { left: 25%; animation-duration: 10s; animation-delay: 2s; font-size: 0.9em; }
.snowflake:nth-child(4) { left: 35%; animation-duration: 14s; animation-delay: 0.5s; font-size: 1.1em; }
.snowflake:nth-child(5) { left: 45%; animation-duration: 9s; animation-delay: 3s; font-size: 0.7em; }
.snowflake:nth-child(6) { left: 55%; animation-duration: 11s; animation-delay: 1.5s; font-size: 1em; }
.snowflake:nth-child(7) { left: 65%; animation-duration: 13s; animation-delay: 2.5s; font-size: 1.3em; }
.snowflake:nth-child(8) { left: 75%; animation-duration: 8s; animation-delay: 0.8s; font-size: 0.85em; }
.snowflake:nth-child(9) { left: 85%; animation-duration: 15s; animation-delay: 3.5s; font-size: 1.15em; }
.snowflake:nth-child(10) { left: 95%; animation-duration: 10s; animation-delay: 1.2s; font-size: 0.95em; }
.snowflake:nth-child(11) { left: 10%; animation-duration: 11s; animation-delay: 4s; font-size: 0.75em; }
.snowflake:nth-child(12) { left: 30%; animation-duration: 9s; animation-delay: 2.8s; font-size: 1.05em; }
.snowflake:nth-child(13) { left: 50%; animation-duration: 12s; animation-delay: 0.3s; font-size: 0.65em; }
.snowflake:nth-child(14) { left: 70%; animation-duration: 14s; animation-delay: 1.8s; font-size: 1.25em; }
.snowflake:nth-child(15) { left: 90%; animation-duration: 10s; animation-delay: 3.2s; font-size: 0.9em; }
.snowflake:nth-child(16) { left: 8%; animation-duration: 13s; animation-delay: 4.5s; font-size: 0.7em; }
.snowflake:nth-child(17) { left: 22%; animation-duration: 9s; animation-delay: 0.7s; font-size: 1.1em; }
.snowflake:nth-child(18) { left: 38%; animation-duration: 11s; animation-delay: 2.2s; font-size: 0.85em; }
.snowflake:nth-child(19) { left: 48%; animation-duration: 14s; animation-delay: 3.8s; font-size: 1.2em; }
.snowflake:nth-child(20) { left: 58%; animation-duration: 8s; animation-delay: 1.3s; font-size: 0.75em; }
.snowflake:nth-child(21) { left: 68%; animation-duration: 12s; animation-delay: 4.2s; font-size: 0.95em; }
.snowflake:nth-child(22) { left: 78%; animation-duration: 10s; animation-delay: 0.4s; font-size: 1.15em; }
.snowflake:nth-child(23) { left: 88%; animation-duration: 15s; animation-delay: 2.6s; font-size: 0.65em; }
.snowflake:nth-child(24) { left: 3%; animation-duration: 11s; animation-delay: 1.9s; font-size: 1.0em; }
.snowflake:nth-child(25) { left: 97%; animation-duration: 9s; animation-delay: 3.4s; font-size: 0.8em; }

.settings-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
}
.settings-toggle-label {
    display: flex;
    align-items: center;
    gap: 8px;
}
.toggle-switch {
    position: relative;
    width: 48px;
    height: 26px;
    background: var(--border);
    border-radius: 13px;
    cursor: pointer;
    transition: background 0.3s;
}
.toggle-switch.active {
    background: var(--primary-color);
}
.toggle-switch::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.toggle-switch.active::after {
    transform: translateX(22px);
}
    </style>
</head>
<body>
    <!-- Snowflakes container for New Year mode -->
    <div class="snowflakes" id="snowflakesContainer" style="display: none;">
        <div class="snowflake">❄</div>
        <div class="snowflake">✦</div>
        <div class="snowflake">*</div>
        <div class="snowflake">❅</div>
        <div class="snowflake">✧</div>
        <div class="snowflake">∗</div>
        <div class="snowflake">❆</div>
        <div class="snowflake">⋆</div>
        <div class="snowflake">⁕</div>
        <div class="snowflake">❄</div>
        <div class="snowflake">✦</div>
        <div class="snowflake">*</div>
        <div class="snowflake">❅</div>
        <div class="snowflake">✧</div>
        <div class="snowflake">∗</div>
        <div class="snowflake">❆</div>
        <div class="snowflake">⋆</div>
        <div class="snowflake">⁕</div>
        <div class="snowflake">❄</div>
        <div class="snowflake">✦</div>
        <div class="snowflake">*</div>
        <div class="snowflake">❅</div>
        <div class="snowflake">✧</div>
        <div class="snowflake">∗</div>
        <div class="snowflake">❆</div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo" id="brandLogo"></div>
            <div class="controls header-controls" id="headerControls">
                <!-- Controls will be rendered by JS -->
            </div>
        </header>
        <main id="mainContent">
            <!-- Контент будет загружен JS -->
        </main>
    </div>

    <footer class="footer" id="pageFooter"></footer>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="settingsTitle">Settings</div>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <label class="settings-label" id="themeLabel">Theme</label>
                    <div class="settings-buttons" id="themeButtons">
                        <button class="btn" onclick="setTheme('light')">☀️ Light</button>
                        <button class="btn" onclick="setTheme('dark')">🌙 Dark</button>
                        <button class="btn" onclick="setTheme('auto')">⚙️ Auto</button>
                    </div>
                    <div class="settings-toggle" id="snowToggleContainer" style="margin-top: 12px;">
                        <div class="settings-toggle-label">
                            <span>❄️</span>
                            <span id="snowToggleLabel">New Year Mode</span>
                        </div>
                        <div class="toggle-switch" id="snowToggle" onclick="toggleSnowMode()"></div>
                    </div>
                </div>
                <div class="settings-section">
                    <label class="settings-label" id="languageLabel">Language</label>
                    <div class="settings-buttons" id="languageButtons"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Setup Modal -->
    <div class="modal" id="appModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="appModalTitle"></div>
                <button class="modal-close" onclick="closeModal('appModal')">&times;</button>
            </div>
            <div class="modal-body" id="appModalBody"></div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="qrModalTitle">QR Code</div>
                <button class="modal-close" onclick="closeModal('qrModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div id="qrCode"></div>
                    <p class="qr-hint" id="qrHint">Scan with your phone</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription QR Modal -->
    <div class="modal" id="subscriptionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="subscriptionModalTitle">Subscription</div>
                <button class="modal-close" onclick="closeModal('subscriptionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div id="subscriptionQrCode"></div>
                    <p class="qr-hint" id="subscriptionQrHint">Scan with your phone</p>
                </div>
                <div style="text-align: center; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="copySubscriptionUrl()" id="copySubBtn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        <span id="copySubBtnText">Copy</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Platform Modal -->
    <div class="modal" id="platformModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="platformModalTitle">Select Platform</div>
                <button class="modal-close" onclick="closeModal('platformModal')">&times;</button>
            </div>
            <div class="modal-body" id="platformModalBody"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Global state
        let panelData = null;
        let appConfig = null;
        let currentLanguage = 'en';
        let currentPlatform = 'ios';
        let currentApp = null;
        let toastTimeout = null;
        let validPlatforms = [];
        let timelineCurrentStep = 0;

        // Language full names for display
        const langFullNames = {
            en: 'English', ru: 'Русский', zh: '中文', fa: 'فارسی', fr: 'Français',
            de: 'Deutsch', es: 'Español', it: 'Italiano', pt: 'Português', ja: '日本語',
            ko: '한국어', ar: 'العربية', tr: 'Türkçe', pl: 'Polski', uk: 'Українська',
            nl: 'Nederlands', vi: 'Tiếng Việt', th: 'ไทย', id: 'Indonesia', ms: 'Melayu',
            az: 'Azərbaycan', uz: 'Oʻzbek', hi: 'हिन्दी', be: 'Беларуская',
            tk: 'Türkmen'
        };

        // HAPP Encrypted Link Support - RSA Public Keys
        const HAPP_PUBLIC_KEY_V3 = `-----BEGIN PUBLIC KEY-----
MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAlBetA0wjbaj+h7oJ/d/h
pNrXvAcuhOdFGEFcfCxSWyLzWk4SAQ05gtaEGZyetTax2uqagi9HT6lapUSUe2S8
nMLJf5K+LEs9TYrhhBdx/B0BGahA+lPJa7nUwp7WfUmSF4hir+xka5ApHjzkAQn6
cdG6FKtSPgq1rYRPd1jRf2maEHwiP/e/jqdXLPP0SFBjWTMt/joUDgE7v/IGGB0L
Q7mGPAlgmxwUHVqP4bJnZ//5sNLxWMjtYHOYjaV+lixNSfhFM3MdBndjpkmgSfmg
D5uYQYDL29TDk6Eu+xetUEqry8ySPjUbNWdDXCglQWMxDGjaqYXMWgxBA1UKjUBW
wbgr5yKTJ7mTqhlYEC9D5V/LOnKd6pTSvaMxkHXwk8hBWvUNWAxzAf5JZ7EVE3jt
0j682+/hnmL/hymUE44yMG1gCcWvSpB3BTlKoMnl4yrTakmdkbASeFRkN3iMRewa
IenvMhzJh1fq7xwX94otdd5eLB2vRFavrnhOcN2JJAkKTnx9dwQwFpGEkg+8U613
+Tfm/f82l56fFeoFN98dD2mUFLFZoeJ5CG81ZeXrH83niI0joX7rtoAZIPWzq3Y1
Zb/Zq+kK2hSIhphY172Uvs8X2Qp2ac9UoTPM71tURsA9IvPNvUwSIo/aKlX5KE3I
VE0tje7twWXL5Gb1sfcXRzsCAwEAAQ==
-----END PUBLIC KEY-----`;

        const HAPP_PUBLIC_KEY_V4 = `-----BEGIN PUBLIC KEY-----
MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA3UZ0M3L4K+WjM3vkbQnz
ozHg/cRbEXvQ6i4A8RVN4OM3rK9kU01FdjyoIgywve8OEKsFnVwERZAQZ1Trv60B
hmaM76QQEE+EUlIOL9EpwKWGtTL5lYC1sT9XJMNP3/CI0gP5wwQI88cY/xedpOEB
W72EmOOShHUm/b/3m+HPmqwc4ugKj5zWV5SyiT829aFA5DxSjmIIFBAms7DafmSq
LFTYIQL5cShDY2u+/sqyAw9yZIOoqW2TFIgIHhLPWek/ocDU7zyOrlu1E0SmcQQb
LFqHq02fsnH6IcqTv3N5Adb/CkZDDQ6HvQVBmqbKZKf7ZdXkqsc/Zw27xhG7OfXC
tUmWsiL7zA+KoTd3avyOh93Q9ju4UQsHthL3Gs4vECYOCS9dsXXSHEY/1ngU/hjO
WFF8QEE/rYV6nA4PTyUvo5RsctSQL/9DJX7XNh3zngvif8LsCN2MPvx6X+zLouBX
zgBkQ9DFfZAGLWf9TR7KVjZC/3NsuUCDoAOcpmN8pENBbeB0puiKMMWSvll36+2M
YR1Xs0MgT8Y9TwhE2+TnnTJOhzmHi/BxiUlY/w2E0s4ax9GHAmX0wyF4zeV7kDkc
vHuEdc0d7vDmdw0oqCqWj0Xwq86HfORu6tm1A8uRATjb4SzjTKclKuoElVAVa5Jo
oh/uZMozC65SmDw+N5p6Su8CAwEAAQ==
-----END PUBLIC KEY-----`;

        const HAPP_CRYPTO_V3 = {
            publicKey: HAPP_PUBLIC_KEY_V3,
            deepLink: 'happ://crypt3/'
        };

        const HAPP_CRYPTO_V4 = {
            publicKey: HAPP_PUBLIC_KEY_V4,
            deepLink: 'happ://crypt4/'
        };

        // Function to encrypt link using RSA public key
        function encryptLink(link, publicKey) {
            try {
                const encrypt = new JSEncrypt();
                encrypt.setPublicKey(publicKey);
                const encrypted = encrypt.encrypt(link);
                return encrypted || null;
            } catch (error) {
                console.error('Encryption error:', error);
                return null;
            }
        }

        // Function to generate HAPP encrypted links
        function generateHappCryptLink(subscriptionUrl, version) {
            if (!subscriptionUrl) return '';

            const cryptoConfig = version === 3 ? HAPP_CRYPTO_V3 : HAPP_CRYPTO_V4;
            const encrypted = encryptLink(subscriptionUrl, cryptoConfig.publicKey);

            if (!encrypted) {
                console.error('Failed to encrypt subscription link for HAPP_CRYPT' + version);
                return '';
            }

            return cryptoConfig.deepLink + encodeURIComponent(encrypted);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            loadSettings();
            loadAppConfig();
            loadPanelData();
        }

        function loadSettings() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);
            const savedLang = localStorage.getItem('lang') || getBrowserLanguage();
            currentLanguage = savedLang;
            // Initialize snow mode
            initSnowMode();
        }

        function getBrowserLanguage() {
            const lang = (navigator.language || navigator.userLanguage).slice(0, 2);
            return appConfig?.locales?.includes(lang) ? lang : (appConfig?.locales?.[0] || 'en');
        }

        function loadAppConfig() {
            fetch('/assets/.app-config-v2.json')
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to load config: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    appConfig = data;

                    // Set meta tags from baseSettings
                    if (appConfig.baseSettings) {
                        if (appConfig.baseSettings.metaTitle) {
                            document.getElementById('pageTitle').textContent = appConfig.baseSettings.metaTitle;
                        }
                        if (appConfig.baseSettings.metaDescription) {
                            document.getElementById('metaDesc').setAttribute('content', appConfig.baseSettings.metaDescription);
                            document.getElementById('pageFooter').textContent = appConfig.baseSettings.metaDescription;
                        }
                    }

                    // Set valid platforms
                    validPlatforms = Object.keys(appConfig.platforms || {}).filter(p => {
                        const platform = appConfig.platforms[p];
                        return platform && platform.apps && platform.apps.length > 0;
                    });

                    // Set language if not already set (now that appConfig is loaded)
                    if (!localStorage.getItem('lang')) {
                        currentLanguage = getBrowserLanguage();
                    }

                    // Setup language buttons
                    setupLanguageButtons();

                    // Update branding
                    updateBranding();

                    // Render header controls
                    renderHeaderControls();

                    // Update all texts
                    updateTexts();
                })
                .catch(error => {
                    console.error('Error loading app config:', error);
                })
                .finally(() => {
                    if (panelData) renderContent();
                });
        }

        function loadPanelData() {
            const panelDataB64 = '<%= panelData %>';
            try {
                panelData = JSON.parse(atob(panelDataB64));
            } catch (error) {
                console.error('Error loading panel data:', error);
                panelData = { response: { isFound: false } };
            }
            if (appConfig !== null) renderContent();
        }

        // Translation function
        function t(key) {
            const translation = appConfig?.baseTranslations?.[key];
            if (translation) {
                return translation[currentLanguage] || translation['en'] || key;
            }
            return key;
        }

        // Get localized text from object
        function getLocalizedText(textObj) {
            if (!textObj) return '';
            if (typeof textObj === 'string') return textObj;
            return textObj[currentLanguage] || textObj['en'] || Object.values(textObj)[0] || '';
        }

        // Get SVG icon from library
        function getSvgIcon(iconKey, className = 'icon-svg') {
            if (!iconKey || !appConfig?.svgLibrary) return '';
            const svg = appConfig.svgLibrary[iconKey];
            if (!svg) return '';
            return svg.replace('<svg', `<svg class="${className}"`);
        }

        // Get icon color CSS
        function getIconColor(colorValue) {
            if (!colorValue) return 'var(--primary-color)';
            if (colorValue.startsWith('#')) return colorValue;
            return `var(--color-${colorValue}, var(--primary-color))`;
        }

        // Hardcoded translations for common UI texts
        const hardcodedTranslations = {
            recommended: {
                en: 'Recommended', ru: 'Рекомендуется', zh: '推荐', fa: 'پیشنهادی', fr: 'Recommandé',
                uz: 'Tavsiya etiladi', hi: 'अनुशंसित', de: 'Empfohlen', tr: 'Önerilen', az: 'Tövsiyə olunur',
                vi: 'Được đề xuất', es: 'Recomendado', ja: '推奨', be: 'Рэкамендуецца', pt: 'Recomendado',
                uk: 'Рекомендовано', pl: 'Zalecane', id: 'Direkomendasikan', tk: 'Maslahat berilýär', th: 'แนะนำ'
            },
            install: {
                en: 'Install and Launch', ru: 'Установить и Запустить', zh: '安装并启动', fa: 'نصب و اجرا', fr: 'Installer et Lancer',
                uz: "O'rnatish va Ishga tushirish", hi: 'इंस्टॉल करें और लॉन्च करें', de: 'Installieren und Starten', tr: 'Yükle ve Başlat', az: 'Quraşdır və İşə sal',
                vi: 'Cài đặt và Khởi chạy', es: 'Instalar e Iniciar', ja: 'インストールして起動', be: 'Усталяваць і Запусціць', pt: 'Instalar e Iniciar',
                uk: 'Встановити та Запустити', pl: 'Zainstaluj i Uruchom', id: 'Instal dan Luncurkan', tk: 'Gurnamak we Başla', th: 'ติดตั้งและเปิด'
            },
            support: {
                en: 'Support', ru: 'Поддержка', zh: '支持', fa: 'پشتیبانی', fr: 'Support',
                uz: 'Yordam', hi: 'सहायता', de: 'Support', tr: 'Destek', az: 'Dəstək',
                vi: 'Hỗ trợ', es: 'Soporte', ja: 'サポート', be: 'Падтрымка', pt: 'Suporte',
                uk: 'Підтримка', pl: 'Wsparcie', id: 'Dukungan', tk: 'Goldaw', th: 'สนับสนุน'
            },
            settings: {
                en: 'Settings', ru: 'Настройки', zh: '设置', fa: 'تنظیمات', fr: 'Paramètres',
                uz: 'Sozlamalar', hi: 'सेटिंग्स', de: 'Einstellungen', tr: 'Ayarlar', az: 'Parametrlər',
                vi: 'Cài đặt', es: 'Ajustes', ja: '設定', be: 'Налады', pt: 'Configurações',
                uk: 'Налаштування', pl: 'Ustawienia', id: 'Pengaturan', tk: 'Sazlamalar', th: 'การตั้งค่า'
            },
            getLink: {
                en: 'Get Link', ru: 'Получить ссылку', zh: '获取链接', fa: 'دریافت لینک', fr: 'Obtenir le lien',
                uz: 'Havolani olish', hi: 'लिंक प्राप्त करें', de: 'Link erhalten', tr: 'Bağlantı Al', az: 'Link əldə et',
                vi: 'Lấy liên kết', es: 'Obtener enlace', ja: 'リンクを取得', be: 'Атрымаць спасылку', pt: 'Obter link',
                uk: 'Отримати посилання', pl: 'Pobierz link', id: 'Dapatkan Tautan', tk: 'Baglanyşyk al', th: 'รับลิงก์'
            },
            selectPlatform: {
                en: 'Select platform', ru: 'Выбрать платформу', zh: '选择平台', fa: 'انتخاب پلتفرم', fr: 'Sélectionner la plateforme',
                uz: 'Platformani tanlang', hi: 'प्लेटफॉर्म चुनें', de: 'Plattform auswählen', tr: 'Platform seçin', az: 'Platformanı seçin',
                vi: 'Chọn nền tảng', es: 'Seleccionar plataforma', ja: 'プラットフォームを選択', be: 'Выберыце платформу', pt: 'Selecionar plataforma',
                uk: 'Вибрати платформу', pl: 'Wybierz platformę', id: 'Pilih platform', tk: 'Platformany saýlaň', th: 'เลือกแพลตฟอร์ม'
            },
            selectApp: {
                en: 'Select application', ru: 'Выбрать приложение', zh: '选择应用', fa: 'انتخاب برنامه', fr: 'Sélectionner l\'application',
                uz: 'Ilovani tanlang', hi: 'एप्लिकेशन चुनें', de: 'Anwendung auswählen', tr: 'Uygulama seçin', az: 'Tətbiqi seçin',
                vi: 'Chọn ứng dụng', es: 'Seleccionar aplicación', ja: 'アプリを選択', be: 'Выберыце праграму', pt: 'Selecionar aplicativo',
                uk: 'Вибрати додаток', pl: 'Wybierz aplikację', id: 'Pilih aplikasi', tk: 'Programmany saýlaň', th: 'เลือกแอปพลิเคชัน'
            },
            theme: {
                en: 'Theme', ru: 'Тема', zh: '主题', fa: 'تم', fr: 'Thème',
                uz: 'Mavzu', hi: 'थीम', de: 'Design', tr: 'Tema', az: 'Mövzu',
                vi: 'Giao diện', es: 'Tema', ja: 'テーマ', be: 'Тэма', pt: 'Tema',
                uk: 'Тема', pl: 'Motyw', id: 'Tema', tk: 'Tema', th: 'ธีม'
            },
            language: {
                en: 'Language', ru: 'Язык', zh: '语言', fa: 'زبان', fr: 'Langue',
                uz: 'Til', hi: 'भाषा', de: 'Sprache', tr: 'Dil', az: 'Dil',
                vi: 'Ngôn ngữ', es: 'Idioma', ja: '言語', be: 'Мова', pt: 'Idioma',
                uk: 'Мова', pl: 'Język', id: 'Bahasa', tk: 'Dil', th: 'ภาษา'
            },
            newYearMode: {
                en: 'New Year Mode', ru: 'Новогодний режим', zh: '新年模式', fa: 'حالت سال نو', fr: 'Mode Nouvel An',
                uz: 'Yangi yil rejimi', hi: 'नए साल का मोड', de: 'Neujahrsmodus', tr: 'Yeni Yıl Modu', az: 'Yeni İl rejimi',
                vi: 'Chế độ Năm mới', es: 'Modo Año Nuevo', ja: '新年モード', be: 'Навагодні рэжым', pt: 'Modo Ano Novo',
                uk: 'Новорічний режим', pl: 'Tryb Noworoczny', id: 'Mode Tahun Baru', tk: 'Täze ýyl rejimi', th: 'โหมดปีใหม่'
            }
        };

        // Language emojis for selector
        const langEmojis = {
            en: '🇬🇧', ru: '🇷🇺', zh: '🇨🇳', fa: '🇮🇷', fr: '🇫🇷', uz: '🇺🇿', hi: '🇮🇳', de: '🇩🇪', tr: '🇹🇷', az: '🇦🇿',
            vi: '🇻🇳', es: '🇪🇸', ja: '🇯🇵', be: '🇧🇾', pt: '🇵🇹', uk: '🇺🇦', pl: '🇵🇱', id: '🇮🇩', tk: '🇹🇲', th: '🇹🇭'
        };

        function getHardcodedText(key) {
            const texts = hardcodedTranslations[key];
            if (!texts) return key;
            return texts[currentLanguage] || texts['en'] || key;
        }

        function updateBranding() {
            if (!appConfig?.brandingSettings) return;
            const branding = appConfig.brandingSettings;

            const logo = document.getElementById('brandLogo');
            if (logo) {
                logo.innerHTML = '';
                if (branding.logoUrl) {
                    const logoImg = document.createElement('img');
                    logoImg.src = branding.logoUrl;
                    logoImg.alt = branding.title || 'Logo';
                    logoImg.className = 'brand-logo';
                    logo.appendChild(logoImg);
                }
                const titleSpan = document.createElement('span');
                titleSpan.textContent = branding.title || 'Subscription';
                logo.appendChild(titleSpan);
                logo.classList.add('loaded');
            }
        }

        function renderHeaderControls() {
            const controls = document.getElementById('headerControls');
            if (!controls) return;

            const branding = appConfig?.brandingSettings;
            let html = '';

            // Support button (if supportUrl exists)
            if (branding?.supportUrl) {
                const isTelegramUrl = branding.supportUrl.startsWith('https://t.me');
                const supportIcon = isTelegramUrl
                    ? `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>`
                    : `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
                html += `<button class="btn btn-icon" onclick="openLink('${escapeForAttribute(branding.supportUrl)}')">${supportIcon}<span class="btn-text">${getHardcodedText('support')}</span></button>`;
            }

            // Settings button
            html += `<button class="btn btn-icon" onclick="openModal('settingsModal')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="btn-text">${getHardcodedText('settings')}</span>
            </button>`;

            // Get Link / QR button (hide if baseSettings.hideGetLinkButton is true)
            if (appConfig?.baseSettings?.hideGetLinkButton !== true) {
                html += `<button class="btn btn-primary btn-icon" onclick="showSubscriptionModal()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                    </svg>
                    <span class="btn-text">${getHardcodedText('getLink')}</span>
                </button>`;
            }

            controls.innerHTML = html;
            controls.classList.add('loaded');
        }

        function setupLanguageButtons() {
            const container = document.getElementById('languageButtons');
            if (!container) return;
            container.innerHTML = '';

            const locales = appConfig?.locales || ['en'];
            locales.forEach(langCode => {
                const button = document.createElement('button');
                button.className = 'btn' + (langCode === currentLanguage ? ' btn-primary' : '');
                const emoji = langEmojis[langCode] || '';
                button.innerHTML = `<span class="lang-emoji">${emoji}</span> ${langFullNames[langCode] || langCode.toUpperCase()}`;
                button.onclick = () => setLanguage(langCode);
                container.appendChild(button);
            });
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('lang', lang);
            updateTexts();
            setupLanguageButtons();
            renderHeaderControls();
            if (panelData?.response?.isFound) renderContent();
        }

        function updateTexts() {
            // Update modal titles and hints
            document.getElementById('qrHint').textContent = t('scanQrCodeDescription') || 'Scan with your phone';
            document.getElementById('subscriptionQrHint').textContent = t('scanQrCodeDescription') || 'Scan with your phone';
            document.getElementById('copySubBtnText').textContent = t('copyLink') || 'Copy';
            // Update settings modal labels
            document.getElementById('settingsTitle').textContent = getHardcodedText('settings');
            document.getElementById('themeLabel').textContent = getHardcodedText('theme');
            document.getElementById('languageLabel').textContent = getHardcodedText('language');
            document.getElementById('snowToggleLabel').textContent = getHardcodedText('newYearMode');
        }

        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const html = document.documentElement;
            const themeColorMeta = document.getElementById('themeColor');
            let isDark;
            if (theme === 'auto') {
                isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            } else {
                isDark = theme === 'dark';
            }
            html.classList.toggle('dark-theme', isDark);
            themeColorMeta.setAttribute('content', isDark ? '#0f172a' : '#3b82f6');
        }

        function isNewYearSeason() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth(); // 0-indexed
            const day = now.getDate();
            // Enable by default from Dec 1 to Jan 12
            if (month === 11) return true; // December
            if (month === 0 && day <= 12) return true; // Jan 1-12
            return false;
        }

        function initSnowMode() {
            const savedSnowMode = localStorage.getItem('snowMode');
            let snowEnabled;
            if (savedSnowMode !== null) {
                snowEnabled = savedSnowMode === 'true';
            } else {
                snowEnabled = isNewYearSeason();
            }
            applySnowMode(snowEnabled);
        }

        function applySnowMode(enabled) {
            const container = document.getElementById('snowflakesContainer');
            const toggle = document.getElementById('snowToggle');
            if (container) {
                container.style.display = enabled ? 'block' : 'none';
            }
            if (toggle) {
                toggle.classList.toggle('active', enabled);
            }
        }

        function toggleSnowMode() {
            const toggle = document.getElementById('snowToggle');
            const isActive = toggle.classList.contains('active');
            const newState = !isActive;
            localStorage.setItem('snowMode', newState.toString());
            applySnowMode(newState);
        }

        function detectOS() {
            const ua = navigator.userAgent;
            const platform = navigator.platform;
            if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return 'ios';
            if (/Android/.test(ua)) return 'android';
            if (/Mac/.test(platform)) return 'macos';
            if (/Win/.test(platform)) return 'windows';
            if (/Linux/.test(platform)) return 'linux';
            return 'ios';
        }

        function renderContent() {
            const mainContent = document.getElementById('mainContent');
            if (!panelData?.response?.isFound) {
                mainContent.innerHTML = `<div class="card"><div class="card-content" style="text-align: center; padding: 40px;">${t('unknown') || 'No data found'}</div></div>`;
                return;
            }

            let html = '';

            // Render subscription info block based on uiConfig
            const infoBlockType = appConfig?.uiConfig?.subscriptionInfoBlockType || 'cards';
            if (infoBlockType !== 'hidden') {
                html += renderSubscriptionInfo(infoBlockType);
            }

            // Render installation section
            html += renderInstallationSection();

            // Render connection keys section if enabled
            if (appConfig?.baseSettings?.showConnectionKeys !== false) {
                html += renderLinksSection();
            }

            mainContent.innerHTML = html;
            mainContent.classList.add('loaded');
            attachEventListeners();
        }

        function renderSubscriptionInfo(blockType) {
            const { user } = panelData.response;
            const expiresDate = new Date(user.expiresAt);
            const isNeverExpires = expiresDate.getFullYear() >= 2099;
            const isActive = user.userStatus.toLowerCase() === 'active';

            // Format traffic
            const trafficUsed = user.trafficUsed || '0 B';
            const trafficLimit = user.trafficLimit === "0" ? '∞' : user.trafficLimit;
            const bandwidth = `${trafficUsed} / ${trafficLimit}`;

            // Get expiry text
            let expiryText = t('indefinitely') || 'Indefinitely';
            if (!isNeverExpires) {
                expiryText = formatDate(expiresDate);
            }

            switch (blockType) {
                case 'collapsed':
                    return renderCollapsedInfo(user, isActive, expiryText, bandwidth, isNeverExpires);
                case 'expanded':
                    return renderExpandedInfo(user, isActive, expiryText, bandwidth, isNeverExpires);
                case 'cards':
                default:
                    return renderCardsInfo(user, isActive, expiryText, bandwidth, isNeverExpires);
            }
        }

        function renderCardsInfo(user, isActive, expiryText, bandwidth, isNeverExpires) {
            const expiresDate = new Date(user.expiresAt);
            const trafficLimit = user.trafficLimit === "0" ? (t('indefinitely') || '∞') : user.trafficLimit;

            let infoRows = `
                <div class="info-row"><span class="info-label">${t('name') || 'Username'}</span><span class="info-value">${escapeHtml(user.username)}</span></div>
                <div class="info-row"><span class="info-label">${t('status') || 'Status'}</span><span class="info-value"><span class="badge badge-${user.userStatus.toLowerCase()}">${isActive ? (t('active') || 'ACTIVE') : (t('inactive') || 'INACTIVE')}</span></span></div>
            `;

            if (isActive) {
                infoRows += `
                    <div class="info-row"><span class="info-label">${t('expires') || 'Expires'}</span><span class="info-value">${expiryText}</span></div>
                    ${!isNeverExpires ? `<div class="info-row"><span class="info-label">${t('expiresIn') || 'Days left'}</span><span class="info-value">${user.daysLeft || 0}</span></div>` : ''}
                    <div class="info-row"><span class="info-label">${t('bandwidth') || 'Traffic used'}</span><span class="info-value">${user.trafficUsed || '0 B'} / ${trafficLimit}</span></div>
                `;
            }

            return `
                <div class="card user-info" style="margin-bottom: 20px;">
                    <div class="card-content">
                        ${infoRows}
                    </div>
                </div>
            `;
        }

        function renderCollapsedInfo(user, isActive, expiryText, bandwidth, isNeverExpires) {
            const trafficLimit = user.trafficLimit === "0" ? (t('indefinitely') || '∞') : user.trafficLimit;

            return `
                <div class="card" style="margin-bottom: 20px;">
                    <div class="user-info-collapsed" onclick="toggleCollapsedInfo(this)">
                        <div class="status-icon ${isActive ? 'active' : 'inactive'}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <div class="user-summary">
                            <div class="user-summary-name">${escapeHtml(user.username)}</div>
                            <div class="user-summary-expire">${expiryText}</div>
                        </div>
                        <div class="expand-icon">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                    </div>
                    <div class="user-info-collapsed-details">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-card-label">${t('name') || 'Username'}</div>
                                <div class="stat-card-value">${escapeHtml(user.username)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">${t('status') || 'Status'}</div>
                                <div class="stat-card-value"><span class="badge badge-${user.userStatus.toLowerCase()}">${isActive ? (t('active') || 'Active') : (t('inactive') || 'Inactive')}</span></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">${t('expires') || 'Expires'}</div>
                                <div class="stat-card-value">${expiryText}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">${t('bandwidth') || 'Bandwidth'}</div>
                                <div class="stat-card-value">${bandwidth}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderExpandedInfo(user, isActive, expiryText, bandwidth, isNeverExpires) {
            const trafficLimit = user.trafficLimit === "0" ? (t('indefinitely') || '∞') : user.trafficLimit;

            return `
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px; padding: 16px 20px; border-bottom: 1px solid var(--border);">
                        <div class="status-icon ${isActive ? 'active' : 'inactive'}" style="width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: ${isActive ? 'var(--success)' : 'var(--error)'}; color: white; flex-shrink: 0;">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 18px;">${escapeHtml(user.username)}</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">${expiryText}</div>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-card-label">${t('name') || 'Username'}</div>
                                <div class="stat-card-value">${escapeHtml(user.username)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">${t('status') || 'Status'}</div>
                                <div class="stat-card-value"><span class="badge badge-${user.userStatus.toLowerCase()}">${isActive ? (t('active') || 'Active') : (t('inactive') || 'Inactive')}</span></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">${t('expires') || 'Expires'}</div>
                                <div class="stat-card-value">${expiryText}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">${t('bandwidth') || 'Bandwidth'}</div>
                                <div class="stat-card-value">${bandwidth}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleCollapsedInfo(element) {
            element.classList.toggle('expanded');
            const details = element.nextElementSibling;
            details.classList.toggle('open');
        }

        function renderInstallationSection() {
            if (!appConfig?.platforms || validPlatforms.length === 0) return '';

            const storedPlatform = localStorage.getItem('platform');
            currentPlatform = validPlatforms.includes(storedPlatform) ? storedPlatform : detectOS();
            if (!validPlatforms.includes(currentPlatform)) {
                currentPlatform = validPlatforms[0];
            }

            const platformData = appConfig.platforms[currentPlatform];
            const platformDisplayName = getLocalizedText(platformData?.displayName) || currentPlatform;
            const platformIcon = getSvgIcon(platformData?.svgIconKey) || '';

            return `
                <div class="card apps-section">
                    <div class="card-header">
                        <span>${t('installationGuideHeader') || 'Installation'}</span>
                        <button class="btn" id="platform-selector-btn" onclick="openPlatformModal()">
                            ${platformIcon} <span>${platformDisplayName}</span>
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="platform-tabs">
                            ${validPlatforms.map(p => {
                                const pData = appConfig.platforms[p];
                                const pName = getLocalizedText(pData?.displayName) || p;
                                const pIcon = getSvgIcon(pData?.svgIconKey) || '';
                                return `<div class="platform-tab ${p === currentPlatform ? 'active' : ''}" data-platform="${p}">${pIcon} ${pName}</div>`;
                            }).join('')}
                        </div>
                        <div id="appsContainer">${renderAppsForPlatform()}</div>
                    </div>
                </div>
            `;
        }

        function renderAppsForPlatform() {
            const platformData = appConfig.platforms[currentPlatform];
            if (!platformData?.apps?.length) return '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No apps available</div>';

            const apps = platformData.apps;
            const guidesType = appConfig?.uiConfig?.installationGuidesBlockType || 'minimal';

            // For minimal mode, use app cards like original
            if (guidesType === 'minimal') {
                return renderAppsCardsView(apps);
            }

            // For timeline mode with multiple apps, use timeline with app selection as first step
            if (guidesType === 'timeline' && apps.length > 1) {
                return renderTimelineWithAppSelection(apps);
            }

            // For other modes (cards, accordion, timeline with single app), use app tabs
            return renderAppsTabsView(apps, guidesType);
        }

        function renderAppsCardsView(apps) {
            // Show all apps in a simple grid with featured badge
            let html = '<div class="apps-container">';
            html += `<div class="apps-grid">${apps.map(app => renderAppCard(app, true)).join('')}</div>`;
            html += '</div>';
            return html;
        }

        // Timeline with app selection as first step
        let timelineApps = [];
        let timelineSelectedAppIndex = 0;
        let timelineHasAppSelection = false;

        function renderTimelineWithAppSelection(apps) {
            timelineApps = apps;
            timelineSelectedAppIndex = 0;
            timelineCurrentStep = 0;
            timelineHasAppSelection = true;

            const selectedApp = apps[0];
            currentApp = selectedApp;

            return renderTimelineWithApps(apps, selectedApp);
        }

        function renderTimelineWithApps(apps, selectedApp) {
            const blocks = selectedApp.blocks || [];
            const totalSteps = 1 + blocks.length; // 1 for app selection + blocks
            const platformIcon = getSvgIcon(appConfig.platforms[currentPlatform]?.svgIconKey);

            let html = '<div class="guides-timeline" data-has-app-selection="true">';

            // Timeline dots
            html += '<div class="timeline-dots">';
            // First dot for app selection
            html += `<div class="timeline-dot ${timelineCurrentStep === 0 ? 'active' : ''}" data-step="0" style="background: var(--primary-color);" onclick="goToTimelineStep(0)">${platformIcon}</div>`;
            // Dots for each block
            blocks.forEach((block, index) => {
                const stepIndex = index + 1;
                const iconColor = getIconColor(block.svgIconColor);
                const icon = getSvgIcon(block.svgIconKey) || platformIcon;
                html += `<div class="timeline-dot ${timelineCurrentStep === stepIndex ? 'active' : ''}" data-step="${stepIndex}" style="background: ${iconColor};" onclick="goToTimelineStep(${stepIndex})">${icon}</div>`;
            });
            html += '</div>';

            // Content container
            html += '<div class="timeline-container">';

            // Step 0: App selection
            html += `<div class="timeline-step ${timelineCurrentStep === 0 ? 'active' : ''}" data-step="0">`;
            html += '<div class="timeline-step-content guide-card">';
            html += `<div class="guide-card-header">
                <div class="guide-card-icon" style="background: var(--primary-color); color: white;">${platformIcon}</div>
                <div class="guide-card-title">${getHardcodedText('selectApp')}</div>
            </div>`;
            html += '<div class="app-tabs">';
            apps.forEach((app, index) => {
                const appIcon = getSvgIcon(app.svgIconKey) || platformIcon;
                const starIcon = app.featured ? '<svg class="star-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>' : '';
                const iconHtml = appIcon ? `<span class="app-tab-icon">${appIcon}</span>` : '';
                html += `<div class="app-tab ${index === timelineSelectedAppIndex ? 'active' : ''}" data-timeline-app-index="${index}" onclick="selectTimelineApp(${index})">
                    ${starIcon}<span class="app-tab-name">${escapeHtml(app.name)}</span>${iconHtml}
                </div>`;
            });
            html += '</div></div></div>';

            // Steps for blocks
            blocks.forEach((block, index) => {
                const stepIndex = index + 1;
                const iconColor = getIconColor(block.svgIconColor);
                const icon = getSvgIcon(block.svgIconKey) || platformIcon;
                html += `<div class="timeline-step ${timelineCurrentStep === stepIndex ? 'active' : ''}" data-step="${stepIndex}">
                    <div class="timeline-step-content guide-card">
                        <div class="guide-card-header">
                            <div class="guide-card-icon" style="background: ${iconColor}; color: white;">${icon}</div>
                            <div class="guide-card-title">${getLocalizedText(block.title)}</div>
                        </div>
                        <div class="guide-card-description">${getLocalizedText(block.description)}</div>
                        <div class="guide-card-buttons">${renderBlockButtons(block, selectedApp, iconColor)}</div>
                    </div>
                </div>`;
            });

            html += '</div>';

            // Navigation buttons
            const nextColor = timelineCurrentStep < totalSteps - 1 ? (timelineCurrentStep === 0 ? getIconColor(blocks[0]?.svgIconColor) : getIconColor(blocks[timelineCurrentStep]?.svgIconColor)) : 'var(--primary-color)';

            html += `<div class="timeline-nav">
                <button class="btn" onclick="prevTimelineStep()" id="timelinePrevBtn" ${timelineCurrentStep === 0 ? 'disabled' : ''}>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <button class="btn btn-primary" onclick="nextTimelineStep()" id="timelineNextBtn" style="background: ${nextColor}; border-color: ${nextColor};" ${timelineCurrentStep === totalSteps - 1 ? 'disabled' : ''}>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </button>
            </div>`;

            html += '</div>';
            return html;
        }

        function selectTimelineApp(appIndex) {
            if (appIndex === timelineSelectedAppIndex) return;
            timelineSelectedAppIndex = appIndex;
            currentApp = timelineApps[appIndex];

            // Re-render the timeline with new app's blocks
            const container = document.querySelector('.guides-timeline[data-has-app-selection="true"]');
            if (container) {
                container.outerHTML = renderTimelineWithApps(timelineApps, timelineApps[appIndex]);
                timelineCurrentStep = 0;
            }
        }

        function renderAppCard(app, showFeaturedBadge = true) {
            const appIcon = getSvgIcon(app.svgIconKey) || getSvgIcon(appConfig.platforms[currentPlatform]?.svgIconKey);
            const recommendedText = getHardcodedText('recommended');

            return `
                <div class="app-card ${app.featured ? 'featured' : ''}" data-app-name="${escapeHtml(app.name)}">
                    ${(app.featured && showFeaturedBadge) ? `<div class="featured-badge">${recommendedText}</div>` : ''}
                    <div class="app-header">
                        <div class="app-icon">${appIcon}</div>
                        <div class="app-name">${escapeHtml(app.name)}</div>
                    </div>
                    <div class="btn btn-primary" style="width: 100%; justify-content: center;">${getHardcodedText('install')}</div>
                </div>
            `;
        }

        function renderAppsTabsView(apps, guidesType) {
            let html = '<div class="app-tabs">';
            apps.forEach((app, index) => {
                const appIcon = getSvgIcon(app.svgIconKey) || getSvgIcon(appConfig.platforms[currentPlatform]?.svgIconKey) || '';
                const starIcon = app.featured ? '<svg class="star-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>' : '';
                const iconHtml = appIcon ? `<span class="app-tab-icon">${appIcon}</span>` : '';
                html += `<div class="app-tab ${index === 0 ? 'active' : ''}" data-app-index="${index}">
                    ${starIcon}<span class="app-tab-name">${escapeHtml(app.name)}</span>${iconHtml}
                </div>`;
            });
            html += '</div>';

            currentApp = apps[0];
            html += `<div id="guidesContainer">${renderGuides(apps[0], guidesType)}</div>`;

            return html;
        }

        function renderGuides(app, guidesType) {
            if (!app?.blocks?.length) return '';

            switch (guidesType) {
                case 'cards':
                    return renderGuidesCards(app);
                case 'accordion':
                    return renderGuidesAccordion(app);
                case 'expanded':
                    return renderGuidesExpanded(app);
                case 'timeline':
                    return renderGuidesTimeline(app);
                case 'minimal':
                default:
                    return renderGuidesMinimal(app);
            }
        }

        function renderGuidesCards(app) {
            let html = '<div class="guides-cards">';
            app.blocks.forEach((block) => {
                const iconColor = getIconColor(block.svgIconColor);
                const icon = getSvgIcon(block.svgIconKey);
                html += `
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <div class="guide-card-icon" style="background: ${iconColor}; color: white;">${icon}</div>
                            <div class="guide-card-title">${getLocalizedText(block.title)}</div>
                        </div>
                        <div class="guide-card-description">${getLocalizedText(block.description)}</div>
                        <div class="guide-card-buttons">${renderBlockButtons(block, app, iconColor)}</div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderGuidesAccordion(app) {
            let html = '<div class="guides-accordion">';
            app.blocks.forEach((block, index) => {
                const iconColor = getIconColor(block.svgIconColor);
                const icon = getSvgIcon(block.svgIconKey);
                html += `
                    <div class="accordion-item ${index === 0 ? 'open' : ''}">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <div class="accordion-icon" style="background: ${iconColor}; color: white;">${icon}</div>
                            <div class="accordion-title">${getLocalizedText(block.title)}</div>
                            <div class="accordion-arrow">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-description">${getLocalizedText(block.description)}</div>
                            <div class="accordion-buttons">${renderBlockButtons(block, app, iconColor)}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderGuidesExpanded(app) {
            let html = '<div class="guides-expanded">';
            app.blocks.forEach((block) => {
                const iconColor = getIconColor(block.svgIconColor);
                const icon = getSvgIcon(block.svgIconKey);
                html += `
                    <div class="expanded-item">
                        <div class="expanded-header">
                            <div class="expanded-icon" style="background: ${iconColor}; color: white;">${icon}</div>
                            <div class="expanded-title">${getLocalizedText(block.title)}</div>
                        </div>
                        <div class="expanded-content">
                            <div class="expanded-description">${getLocalizedText(block.description)}</div>
                            <div class="expanded-buttons">${renderBlockButtons(block, app, iconColor)}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderGuidesMinimal(app) {
            let html = '<div class="guides-minimal">';
            app.blocks.forEach((block, index) => {
                const iconColor = getIconColor(block.svgIconColor);
                html += `
                    <div class="step">
                        <div class="step-title">
                            <span class="step-number" style="background: ${iconColor};">${index + 1}</span>
                            ${getLocalizedText(block.title)}
                        </div>
                        <div class="step-description">${getLocalizedText(block.description)}</div>
                        <div class="step-buttons">${renderBlockButtons(block, app, iconColor)}</div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        let timelineBlocks = []; // Store blocks for nav button updates

        function renderGuidesTimeline(app) {
            timelineCurrentStep = 0;
            const blocks = app.blocks;
            timelineBlocks = blocks; // Store for nav updates
            const platformIcon = getSvgIcon(appConfig.platforms[currentPlatform]?.svgIconKey);

            let html = '<div class="guides-timeline">';

            // Timeline dots with icons and colors
            html += '<div class="timeline-dots">';
            blocks.forEach((block, index) => {
                const iconColor = getIconColor(block.svgIconColor);
                const icon = getSvgIcon(block.svgIconKey) || platformIcon;
                html += `<div class="timeline-dot ${index === 0 ? 'active' : ''}" data-step="${index}" style="background: ${iconColor};" onclick="goToTimelineStep(${index})">${icon}</div>`;
            });
            html += '</div>';

            html += '<div class="timeline-container">';
            blocks.forEach((block, index) => {
                const iconColor = getIconColor(block.svgIconColor);
                const icon = getSvgIcon(block.svgIconKey) || platformIcon;
                html += `
                    <div class="timeline-step ${index === 0 ? 'active' : ''}" data-step="${index}" data-color="${iconColor}">
                        <div class="timeline-step-content guide-card">
                            <div class="guide-card-header">
                                <div class="guide-card-icon" style="background: ${iconColor}; color: white;">${icon}</div>
                                <div class="guide-card-title">${getLocalizedText(block.title)}</div>
                            </div>
                            <div class="guide-card-description">${getLocalizedText(block.description)}</div>
                            <div class="guide-card-buttons" data-btn-color="${iconColor}">${renderBlockButtons(block, app, iconColor)}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            // Nav buttons with step icons
            const prevIcon = blocks.length > 1 ? (getSvgIcon(blocks[0].svgIconKey) || platformIcon) : '';
            const nextIcon = blocks.length > 1 ? (getSvgIcon(blocks[1].svgIconKey) || platformIcon) : '';
            const prevColor = blocks.length > 0 ? getIconColor(blocks[0].svgIconColor) : 'var(--primary-color)';
            const nextColor = blocks.length > 1 ? getIconColor(blocks[1].svgIconColor) : 'var(--primary-color)';

            html += `
                <div class="timeline-nav">
                    <button class="btn btn-icon" onclick="prevTimelineStep()" id="timelinePrevBtn" disabled style="--btn-color: ${prevColor};">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        <span class="nav-step-icon">${prevIcon}</span>
                    </button>
                    <button class="btn btn-primary btn-icon" onclick="nextTimelineStep()" id="timelineNextBtn" style="background: ${nextColor}; border-color: ${nextColor};">
                        <span class="nav-step-icon">${nextIcon}</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>
            `;
            html += '</div>';
            return html;
        }

        function renderBlockButtons(block, app, btnColor = null) {
            if (!block.buttons?.length) return '';
            const { response } = panelData || {};
            let html = '';
            const colorStyle = btnColor ? `style="background: ${btnColor}; border-color: ${btnColor};"` : '';

            block.buttons.forEach(button => {
                const buttonText = getLocalizedText(button.text);
                const buttonIcon = getSvgIcon(button.svgIconKey, 'w-4 h-4');
                const buttonType = button.type || 'external';
                let buttonLink = button.link || '';

                // Support for template variables in ALL button types (no encoding)
                if (buttonLink && response) {
                    if (response.subscriptionUrl) {
                        buttonLink = buttonLink.replace(/\{\{SUBSCRIPTION_LINK\}\}/g, response.subscriptionUrl);

                        // Generate encrypted HAPP links
                        const happCrypt3Link = generateHappCryptLink(response.subscriptionUrl, 3);
                        const happCrypt4Link = generateHappCryptLink(response.subscriptionUrl, 4);

                        if (happCrypt3Link) {
                            buttonLink = buttonLink.replace(/\{\{HAPP_CRYPT3_LINK\}\}/g, happCrypt3Link);
                        }
                        if (happCrypt4Link) {
                            buttonLink = buttonLink.replace(/\{\{HAPP_CRYPT4_LINK\}\}/g, happCrypt4Link);
                        }
                    }
                    if (response.user?.username) {
                        buttonLink = buttonLink.replace(/\{\{USERNAME\}\}/g, response.user.username);
                    }
                }

                if (buttonType === 'subscriptionLink' || buttonType === 'subscription') {
                    const subscriptionUrl = generateSubscriptionUrl(app, response?.subscriptionUrl, button.link);
                    if (subscriptionUrl) {
                        html += `<button class="btn btn-primary" ${colorStyle} onclick="openSubscriptionUrl('${escapeForAttribute(subscriptionUrl)}')">${buttonIcon} ${buttonText}</button>`;
                    }
                } else if (buttonType === 'copyButton' || buttonType === 'copy') {
                    html += `<button class="btn btn-primary" ${colorStyle} onclick="copyToClipboard('${escapeForAttribute(buttonLink)}')">${buttonIcon} ${buttonText}</button>`;
                } else {
                    // external and any other type - open link
                    html += `<button class="btn btn-primary" ${colorStyle} onclick="openLink('${escapeForAttribute(buttonLink)}')">${buttonIcon} ${buttonText}</button>`;
                }
            });

            return html;
        }

        function generateSubscriptionUrl(app, subscriptionUrl, linkTemplate) {
            if (!subscriptionUrl) return null;
            if (linkTemplate) {
                let result = linkTemplate
                    .replace(/\{\{SUBSCRIPTION_LINK\}\}/g, subscriptionUrl);

                // Generate encrypted HAPP links
                const happCrypt3Link = generateHappCryptLink(subscriptionUrl, 3);
                const happCrypt4Link = generateHappCryptLink(subscriptionUrl, 4);

                if (happCrypt3Link) {
                    result = result.replace(/\{\{HAPP_CRYPT3_LINK\}\}/g, happCrypt3Link);
                }
                if (happCrypt4Link) {
                    result = result.replace(/\{\{HAPP_CRYPT4_LINK\}\}/g, happCrypt4Link);
                }

                const username = panelData?.response?.user?.username;
                if (username) {
                    result = result.replace(/\{\{USERNAME\}\}/g, username);
                }
                return result;
            }
            return null;
        }

        function goToTimelineStep(step) {
            const container = document.querySelector('.guides-timeline');
            const hasAppSelection = container?.dataset.hasAppSelection === 'true';
            const steps = document.querySelectorAll('.timeline-step');
            const dots = document.querySelectorAll('.timeline-dot');
            const prevBtn = document.getElementById('timelinePrevBtn');
            const nextBtn = document.getElementById('timelineNextBtn');
            const platformIcon = getSvgIcon(appConfig?.platforms?.[currentPlatform]?.svgIconKey);

            if (step < 0 || step >= steps.length) return;
            timelineCurrentStep = step;

            steps.forEach((s, i) => s.classList.toggle('active', i === step));
            dots.forEach((d, i) => {
                d.classList.remove('active', 'completed');
                if (i === step) d.classList.add('active');
                if (i < step) d.classList.add('completed');
            });

            // Get blocks based on mode
            let blocks;
            if (hasAppSelection) {
                const selectedApp = timelineApps[timelineSelectedAppIndex];
                blocks = selectedApp?.blocks || [];
            } else {
                blocks = timelineBlocks;
            }

            // Update prev button
            if (prevBtn) {
                prevBtn.disabled = step === 0;
                const blockIndex = hasAppSelection ? step - 2 : step - 1;
                if (step > 0 && blockIndex >= 0 && blocks[blockIndex]) {
                    const prevBlock = blocks[blockIndex];
                    const prevIcon = getSvgIcon(prevBlock.svgIconKey) || platformIcon;
                    const prevIconSpan = prevBtn.querySelector('.nav-step-icon');
                    if (prevIconSpan) prevIconSpan.innerHTML = prevIcon;
                }
            }

            // Update next button
            if (nextBtn) {
                const isLast = step === steps.length - 1;
                nextBtn.disabled = isLast;
                const blockIndex = hasAppSelection ? step : step + 1;
                if (!isLast && blocks[blockIndex]) {
                    const nextBlock = blocks[blockIndex];
                    const nextIcon = getSvgIcon(nextBlock.svgIconKey) || platformIcon;
                    const nextColor = getIconColor(nextBlock.svgIconColor);
                    nextBtn.style.background = nextColor;
                    nextBtn.style.borderColor = nextColor;
                    const nextIconSpan = nextBtn.querySelector('.nav-step-icon');
                    if (nextIconSpan) nextIconSpan.innerHTML = nextIcon;
                } else if (!isLast && hasAppSelection && step === 0) {
                    // First step to block step
                    const nextColor = blocks[0] ? getIconColor(blocks[0].svgIconColor) : 'var(--primary-color)';
                    nextBtn.style.background = nextColor;
                    nextBtn.style.borderColor = nextColor;
                }
            }
        }

        function prevTimelineStep() { goToTimelineStep(timelineCurrentStep - 1); }
        function nextTimelineStep() {
            const steps = document.querySelectorAll('.timeline-step');
            if (timelineCurrentStep < steps.length - 1) goToTimelineStep(timelineCurrentStep + 1);
        }

        function toggleAccordion(header) {
            const item = header.parentElement;
            const wasOpen = item.classList.contains('open');
            // Close all accordion items first
            document.querySelectorAll('.accordion-item.open').forEach(el => el.classList.remove('open'));
            // Open clicked item if it wasn't open before
            if (!wasOpen) item.classList.add('open');
        }
        function toggleSpoiler(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.spoiler-arrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        function renderLinksSection() {
            const { links } = panelData.response;
            if (!links?.length) return '';

            return `
                <div class="card links-section" id="linksSection">
                    <div class="card-header clickable" onclick="toggleLinksSection()">
                        <span>${t('connectionKeysHeader') || 'Connection Keys'}</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="badge" style="background: var(--primary-color); color: white;">${links.length}</span>
                            <svg class="w-5 h-5 expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                    </div>
                    <div class="card-content">
                        ${links.map(link => `
                            <div class="link-item">
                                <div class="link-info">
                                    <div class="link-name">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                                        </svg>
                                        ${escapeHtml(extractLinkName(link))}
                                    </div>
                                </div>
                                <div class="link-actions">
                                    <button class="btn btn-sm copy-btn" data-copy-text="${escapeHtml(link)}" title="${t('copyLink') || 'Copy'}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                        </svg>
                                    </button>
                                    <button class="btn btn-sm qr-btn" data-qr-text="${escapeHtml(link)}" data-qr-title="${escapeHtml(extractLinkName(link))}" title="${t('scanQrCode') || 'QR Code'}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function toggleLinksSection() {
            const section = document.getElementById('linksSection');
            if (section) section.classList.toggle('open');
        }

        function attachEventListeners() {
            // Platform tabs
            document.querySelectorAll('.platform-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const platform = e.currentTarget.dataset.platform;
                    if (platform) switchPlatform(platform);
                });
            });

            // App tabs
            document.querySelectorAll('.app-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const appIndex = parseInt(e.currentTarget.dataset.appIndex);
                    switchApp(appIndex);
                });
            });

            // App cards (for minimal mode)
            document.querySelectorAll('.app-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const appName = e.currentTarget.dataset.appName;
                    const platformData = appConfig.platforms[currentPlatform];
                    const app = platformData?.apps?.find(a => a.name === appName);
                    if (app) showAppSetupModal(app);
                });
            });

            // Copy buttons
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyToClipboard(e.currentTarget.dataset.copyText);
                });
            });

            // QR buttons
            document.querySelectorAll('.qr-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const { qrText, qrTitle } = e.currentTarget.dataset;
                    showQrModal(qrText, qrTitle);
                });
            });

            checkTabsOverflow();
            window.addEventListener('resize', checkTabsOverflow);
        }

        function switchPlatform(platform) {
            if (!platform || platform === currentPlatform) return;
            currentPlatform = platform;
            localStorage.setItem('platform', platform);

            document.querySelectorAll('.platform-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.platform === platform);
            });

            const platformData = appConfig.platforms[platform];
            const platformDisplayName = getLocalizedText(platformData?.displayName) || platform;
            const platformIcon = getSvgIcon(platformData?.svgIconKey) || '';

            const button = document.getElementById('platform-selector-btn');
            if (button) button.innerHTML = `${platformIcon} <span>${platformDisplayName}</span>`;

            const appsContainer = document.getElementById('appsContainer');
            if (appsContainer) {
                appsContainer.innerHTML = renderAppsForPlatform();
                attachEventListeners();
            }
        }

        function switchApp(appIndex) {
            const platformData = appConfig.platforms[currentPlatform];
            if (!platformData?.apps?.[appIndex]) return;

            currentApp = platformData.apps[appIndex];

            document.querySelectorAll('.app-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === appIndex);
            });

            const guidesType = appConfig?.uiConfig?.installationGuidesBlockType || 'minimal';
            const guidesContainer = document.getElementById('guidesContainer');
            if (guidesContainer) guidesContainer.innerHTML = renderGuides(currentApp, guidesType);
        }

        function showAppSetupModal(app) {
            if (!app) return;
            const titleEl = document.getElementById('appModalTitle');
            const appIcon = getSvgIcon(app.svgIconKey);
            titleEl.innerHTML = `<div class="app-icon" style="width: 32px; height: 32px;">${appIcon}</div><span>${escapeHtml(app.name)}</span>`;

            const modalBody = document.getElementById('appModalBody');
            modalBody.innerHTML = renderGuidesMinimal(app);
            openModal('appModal');
        }

        function openPlatformModal() {
            const modalBody = document.getElementById('platformModalBody');
            modalBody.innerHTML = `
                <div class="platform-modal-list">
                    ${validPlatforms.map(p => {
                        const pData = appConfig.platforms[p];
                        const pName = getLocalizedText(pData?.displayName) || p;
                        const pIcon = getSvgIcon(pData?.svgIconKey) || '';
                        return `<div class="platform-modal-item" data-platform="${p}">${pIcon} <span>${pName}</span></div>`;
                    }).join('')}
                </div>
            `;

            modalBody.querySelectorAll('.platform-modal-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const platform = e.currentTarget.dataset.platform;
                    switchPlatform(platform);
                    closeModal('platformModal');
                });
            });

            openModal('platformModal');
        }

        function checkTabsOverflow() {
            // CSS media query at 1024px handles visibility
            // On resize, clear any inline styles to let CSS take control
            const tabs = document.querySelector('.platform-tabs');
            const button = document.getElementById('platform-selector-btn');
            if (tabs) tabs.style.display = '';
            if (button) button.style.display = '';
        }

        function showQrModal(data, title) {
            if (!data) return;
            document.getElementById('qrModalTitle').textContent = title || t('scanQrCode') || 'QR Code';
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = '';
            try {
                const qr = qrcode(0, 'M');
                qr.addData(data);
                qr.make();
                qrContainer.innerHTML = qr.createImgTag(5, 10);
            } catch (e) {
                console.error('QR generation failed:', e);
                qrContainer.textContent = 'Error generating QR code.';
            }
            openModal('qrModal');
        }

        function showSubscriptionModal() {
            const url = panelData?.response?.subscriptionUrl;
            if (!url) return;

            document.getElementById('subscriptionModalTitle').textContent = t('scanToImport') || 'Subscription Link';

            const qrContainer = document.getElementById('subscriptionQrCode');
            qrContainer.innerHTML = '';
            try {
                const qr = qrcode(0, 'M');
                qr.addData(url);
                qr.make();
                qrContainer.innerHTML = qr.createImgTag(5, 10);
            } catch (e) {
                console.error('QR generation failed:', e);
                qrContainer.textContent = 'Error generating QR code.';
            }

            openModal('subscriptionModal');
        }

        function copySubscriptionUrl() { copyToClipboard(panelData?.response?.subscriptionUrl); }

        function copyToClipboard(text) {
            if (!text) return;
            navigator.clipboard.writeText(text)
                .then(() => showToast(t('linkCopied') || 'Copied!'))
                .catch(err => console.error('Could not copy text: ', err));
        }

        function showToast(message) {
            if (toastTimeout) clearTimeout(toastTimeout);
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function openLink(url) {
            try {
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.openLink(url);
                } else {
                    window.open(url, '_blank');
                }
            } catch (error) {
                console.error('Failed to open URL:', error);
                window.open(url, '_blank');
            }
        }

        function openSubscriptionUrl(url) {
            if (!url || url === '#') return;

            const REDIRECT_BASE = 'https://legiz-ru.github.io/Orion/redirect-page/?redirect_to=';
            const isInTelegram = window.Telegram?.WebApp?.initData;

            let finalUrl = url;
            if (isInTelegram) finalUrl = REDIRECT_BASE + encodeURIComponent(url);

            try {
                if (isInTelegram) {
                    window.Telegram.WebApp.openLink(finalUrl);
                } else {
                    window.open(finalUrl, '_blank');
                }
            } catch (error) {
                console.error('Failed to open subscription URL:', error);
                window.open(finalUrl, '_blank');
            }
        }

        function openModal(id) { document.getElementById(id)?.classList.add('active'); }
        function closeModal(id) { document.getElementById(id)?.classList.remove('active'); }

        function extractLinkName(link) {
            try { return decodeURIComponent(new URL(link).hash.substring(1)); }
            catch {
                const i = link.indexOf('#');
                if (i !== -1) try { return decodeURIComponent(link.substring(i + 1)); } catch {}
            }
            return 'Server Link';
        }

        function formatDate(d) {
            return new Date(d).toLocaleDateString(currentLanguage === 'ru' ? 'ru-RU' : currentLanguage === 'fa' ? 'fa-IR' : 'en-GB');
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeForAttribute(text) {
            if (typeof text !== 'string') return '';
            return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // Event listeners
        document.addEventListener('click', e => { if (e.target.classList.contains('modal')) e.target.classList.remove('active'); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active')); });
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if (localStorage.getItem('theme') === 'auto') applyTheme('auto'); });
    </script>
</body>
</html>
